<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>學生上課紀錄流程測試</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', Arial, sans-serif; background: #f5f7fa; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .header h1 { margin: 0; font-size: 24px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); }
        .steps-container { padding: 20px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #667eea; }
        .steps-container ol { margin-left: 20px; }
        .steps-container li { margin-bottom: 8px; color: #333; }
        
        .tabs { display: flex; gap: 0; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab { padding: 12px 24px; cursor: pointer; background: #f0f0f0; border: 1px solid #ddd; border-bottom: none; border-radius: 4px 4px 0 0; }
        .tab.active { background: white; border-bottom: 2px solid white; margin-bottom: -2px; font-weight: bold; color: #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #409eff; color: white; }
        .btn-primary:hover { background: #66b1ff; }
        .btn-default { background: #ddd; color: #333; }
        .btn-default:hover { background: #ccc; }
        .btn-small { padding: 5px 15px; font-size: 12px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 16px; background: white; }
        th, td { padding: 12px; text-align: left; border: 1px solid #ddd; }
        th { background: #f5f7fa; font-weight: bold; color: #333; }
        tr:nth-child(even) { background: #fafafa; }
        tr:hover { background: #f0f9ff; }
        
        .empty { text-align: center; padding: 40px; color: #999; }
        .error { background: #fee; color: #c00; padding: 12px; border-radius: 4px; margin-top: 12px; }
        .success { background: #efe; color: #060; padding: 12px; border-radius: 4px; margin-top: 12px; }
        .info { background: #e7f3ff; color: #0066cc; padding: 12px; border-radius: 4px; margin-top: 12px; }
        input[type="number"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 200px; }
        .loading { color: #409eff; }
    </style>
</head>
<body>
    <div class="header">
        <h1>📚 學生上課紀錄流程測試</h1>
    </div>
    
    <div class="container">
        <!-- 登入區塊 -->
        <div class="card" style="background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%); border-left: 4px solid #667eea;">
            <h2 style="margin-bottom: 16px;">🔐 登入驗證</h2>
            <div style="display: grid; grid-template-columns: auto auto auto 1fr; gap: 12px; align-items: center;">
                <div>
                    <label style="display: block; margin-bottom: 4px; font-weight: bold;">帳號:</label>
                    <input type="text" id="loginUsername" placeholder="請輸入帳號" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 180px;" />
                </div>
                <div>
                    <label style="display: block; margin-bottom: 4px; font-weight: bold;">密碼:</label>
                    <input type="password" id="loginPassword" placeholder="請輸入密碼" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 180px;" />
                </div>
                <div style="padding-top: 20px;">
                    <button class="btn-primary" onclick="doLogin()" style="padding: 10px 24px;">登入</button>
                    <button class="btn-default" onclick="doLogout()" style="padding: 10px 24px; margin-left: 8px;">登出</button>
                </div>
                <div id="loginStatus" style="padding-top: 20px; padding-left: 12px;">
                    <span style="color: #999;">⚠️ 尚未登入</span>
                </div>
            </div>
            <div id="loginError" class="error" style="display:none; margin-top: 12px;"></div>
        </div>

        <!-- 流程指引 -->
        <div class="card">
            <h2 style="margin-bottom: 16px;">🎯 流程指引</h2>
            <div class="steps-container">
                <ol>
                    <li><strong>管理員</strong>：建立老師、學生、課程（後台現有 API）</li>
                    <li><strong>管理員</strong>：為學生新增門禁時間（自動產生課表）</li>
                    <li><strong>管理員</strong>：建立「上課紀錄」(Schedule/Attendance)</li>
                    <li><strong>老師或學生</strong>：簽到 (課程一 ~ 課程四)</li>
                    <li><strong>學生繳款</strong>：建立 Payment / StudentPermissionFee</li>
                    <li><strong>查詢</strong>：使用下方接口檢視學生上課紀錄總覽</li>
                </ol>
            </div>

            <h3 style="margin-top: 20px;">📊 整體流程資料流</h3>
            <div style="background: #fffbf0; border-left: 4px solid #ff9800; padding: 12px; border-radius: 4px; margin-top: 10px;">
                <h4 style="color: #ff9800; margin-bottom: 10px;">1️⃣ 初始化階段</h4>
                <ul style="margin-left: 20px; color: #333;">
                    <li><strong>建立老師/學生/課程:</strong> 透過後台管理界面或 API 在 tblUsers (角色為教師/學生)、tblCourse、tblCourseType、tblCourseFee 等表中新增基本資料。</li>
                    <li><strong>設定課程收費:</strong> 在 tblCourseFee 中定義課程金額、材料費、拆帳比 (SplitRatio)。</li>
                </ul>

                <h4 style="color: #ff9800; margin-bottom: 10px; margin-top: 16px;">2️⃣ 權限授予階段</h4>
                <ul style="margin-left: 20px; color: #333;">
                    <li><strong>新增學生權限 (tblStudentPermission):</strong> 指定學生、老師、課程、教室、上課日期/時間、課表模式 (Schedule Mode)、上課模式 (Course Mode)。系統自動根據週期設定在 tblSchedule 中生成課程表。</li>
                    <li><strong>建立學生權限費用 (tblStudentPermissionFee):</strong> 每筆 StudentPermission 在新增時或手動建立對應的費用記錄，記錄該期課程的「定額」與「繳款」狀態。一個 StudentPermission 可對應多筆 StudentPermissionFee (按課程週期分組)。</li>
                </ul>

                <h4 style="color: #ff9800; margin-bottom: 10px; margin-top: 16px;">3️⃣ 簽到紀錄階段</h4>
                <ul style="margin-left: 20px; color: #333;">
                    <li><strong>建立上課紀錄 (tblAttendance):</strong> 老師或管理員為每堂課建立簽到記錄，記錄上課日期、類型 (出席/病假/事假)、修改者。</li>
                    <li><strong>記錄簽到費用 (tblAttendanceFee):</strong> 對應每筆 Attendance，記錄該堂課的「實際上課時數」(Hours)、「單堂學費」(Amount)、「增減金額」(AdjustmentAmount)，以及「來源實收」(SourceHoursTotalAmount)。</li>
                    <li><strong>分組對應:</strong> 系統依 StudentPermission 的所有 Attendance 日期排序，每 4 筆簽到對應一筆 StudentPermissionFee，用以判斷該組簽到是否已繳款。</li>
                </ul>

                <h4 style="color: #ff9800; margin-bottom: 10px; margin-top: 16px;">4️⃣ 繳款管理階段</h4>
                <ul style="margin-left: 20px; color: #333;">
                    <li><strong>建立繳款記錄 (tblPayment):</strong> 當學生繳款時，在 tblPayment 中建立一筆記錄，記錄「繳款日期」(PayDate)、「繳款金額」(Pay)、「折扣」(DiscountAmount)、「備註」(Remark)，並與對應的 StudentPermissionFee 關聯 (一對一)。</li>
                    <li><strong>更新費用狀態:</strong> StudentPermissionFee 記錄繳款後，其 Payment 欄位被填充，系統以此判斷該組課程是否「已繳費」。</li>
                </ul>

                <h4 style="color: #ff9800; margin-bottom: 10px; margin-top: 16px;">5️⃣ 查詢與報表階段</h4>
                <ul style="margin-left: 20px; color: #333;">
                    <li><strong>學生權限列表查詢 (tblStudentPermission):</strong> 查詢特定學生的所有已授予權限及其簽到摘要，包括「簽到次數」、「未繳費次數」等，透過 GET /api/v1/StudentAttendance/{userId}。</li>
                    <li><strong>簽到詳細查詢 (tblAttendance + tblAttendanceFee + tblPayment):</strong> 查詢特定 StudentPermission 的所有簽到記錄及最近繳款資訊，透過 GET /api/v1/StudentAttendance/Detail/{studentPermissionId}。</li>
                    <li><strong>薪資明細表 (PDF):</strong> 依老師與日期統計所有簽到金額、時數，聚合成每位老師的薪資表，透過 GET /api/pdf/v1/SalaryReport。</li>
                    <li><strong>公司獲利彙總表 (PDF):</strong> 按老師分組統計實收學費、折帳薪資、毛利，透過 GET /api/pdf/v1/CompanyProfitSummary。</li>
                </ul>

                <h4 style="color: #ff9800; margin-bottom: 10px; margin-top: 16px;">6️⃣ 軟刪除與審計</h4>
                <ul style="margin-left: 20px; color: #333;">
                    <li><strong>軟刪除機制:</strong> tblStudentPermission、tblAttendance、tblStudentPermissionFee 等核心表都使用 IsDelete 欄位而非物理刪除，確保資料可溯源。</li>
                    <li><strong>審計日誌 (tblAuditLog):</strong> 重要操作 (新增、編輯、刪除課程、建立/修改費用等) 會被記錄在審計表中，包括操作時間、操作人、操作類型、影響的記錄 ID 等。</li>
                </ul>

                <h4 style="color: #ff9800; margin-bottom: 10px; margin-top: 16px;">💾 核心資料表關係圖</h4>
                <div style="background: white; padding: 12px; border-radius: 4px; border: 1px solid #ddd; margin-top: 10px; font-family: monospace; font-size: 12px; overflow-x: auto;">
<pre>tblUser (老師/學生)
    ↓ 1:N
tblStudentPermission (學生授課權限)
    ├─ 1:N → tblAttendance (簽到記錄)
    │           ↓ 1:1
    │       tblAttendanceFee (簽到費用)
    │
    └─ 1:N → tblStudentPermissionFee (權限費用)
                    ↓ 1:1
                tblPayment (繳款記錄)

tblCourse (課程)
    ↓ 1:1
tblCourseFee (課程收費)

tblSchedule (課表，由權限自動產生)

tblAuditLog (審計日誌)</pre>
                </div>
            </div>
        </div>

        <!-- Tab 菜單 -->
        <div class="card">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('teachers')">👨‍🏫 老師列表</div>
                <div class="tab" onclick="switchTab('students')">👨‍🎓 學生列表</div>
                <div class="tab" onclick="switchTab('courses')">📚 課程列表</div>
                <div class="tab" onclick="switchTab('classrooms')">🏢 教室列表</div>
                <div class="tab" onclick="switchTab('permission')">🔑 新增門禁時間</div>
                <div class="tab" onclick="switchTab('addattend')">✅ 學生簽到</div>
                <div class="tab" onclick="switchTab('closeaccount')">📋 關帳管理</div>
                <div class="tab" onclick="switchTab('attendance')">📝 查 學生權限</div>
                <div class="tab" onclick="switchTab('payment')">💳 繳費管理</div>
                <div class="tab" onclick="switchTab('docs')">📖 API 文檔</div>
            </div>

            <!-- 老師列表 Tab -->
            <div id="teachers" class="tab-content active">
                <div style="padding: 16px 0;">
                    <button class="btn-primary" onclick="loadTeachers()">🔄 載入老師列表</button>
                    <button class="btn-default" onclick="clearTeachers()">清除</button>
                </div>
                <div id="teachersContent"></div>
                <div id="teachersError" class="error" style="display:none;"></div>
            </div>

            <!-- 學生列表 Tab -->
            <div id="students" class="tab-content">
                <div style="padding: 16px 0;">
                    <button class="btn-primary" onclick="loadStudents()">🔄 載入學生列表</button>
                    <button class="btn-default" onclick="clearStudents()">清除</button>
                </div>
                <div id="studentsContent"></div>
                <div id="studentsError" class="error" style="display:none;"></div>
            </div>

            <!-- 課程列表 Tab -->
            <div id="courses" class="tab-content">
                <div style="padding: 16px 0;">
                    <button class="btn-primary" onclick="loadCourses()">🔄 載入課程列表</button>
                    <button class="btn-primary" onclick="loadCourseTypes()">🏷️ 載入課程類型</button>
                    <button class="btn-primary" onclick="showAddCourseDialog()">➕ 新增課程</button>
                    <button class="btn-default" onclick="clearCourses()">清除</button>
                </div>
                <div id="coursesContent"></div>
                <div id="coursesError" class="error" style="display:none;"></div>
                
                <!-- 課程類型列表 -->
                <div id="courseTypesSection" style="display:none; margin-top: 24px; padding: 16px; background: #f0f9ff; border-radius: 8px;">
                    <h4 style="margin: 0 0 12px 0; color: #333;">課程類型列表</h4>
                    <div id="courseTypesContent"></div>
                    <div id="courseTypesError" class="error" style="display:none;"></div>
                </div>
                
                <!-- 課程詳情查詢 -->
                <div style="margin-top: 24px; padding: 16px; background: #f5f7fa; border-radius: 8px;">
                    <h4 style="margin: 0 0 12px 0; color: #333;">查詢課程詳情</h4>
                    <div style="display: flex; gap: 8px; align-items: flex-end;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">課程 ID:</label>
                            <input type="number" id="singleCourseId" placeholder="輸入課程 ID" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;" />
                        </div>
                        <button class="btn-primary" onclick="loadCourseDetail()">查詢</button>
                    </div>
                </div>
                <div id="courseDetailStatus" style="color: #666; font-style: italic; margin-top:12px;"></div>
                <div id="courseDetailError" class="error" style="display:none; margin-top:12px;"></div>
                <div id="courseDetailContent" style="margin-top:12px;"></div>
                
                <!-- 新增/編輯課程對話框 -->
                <div id="courseDialog" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 8px; padding: 24px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <h3 id="courseDialogTitle" style="margin-bottom: 20px;">新增課程</h3>
                        <div style="display: grid; gap: 12px;">
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-weight: bold;">課程名稱 *:</label>
                                <input type="text" id="dialogCourseName" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-weight: bold;">課程類型 ID:</label>
                                <input type="number" id="dialogCourseTypeId" placeholder="選填" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-weight: bold;">課程類別:</label>
                                <input type="text" id="dialogCategory" placeholder="例如: 程式設計" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-weight: bold;">排序順序:</label>
                                <input type="number" id="dialogSortOrder" value="500" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-weight: bold;">收費編號:</label>
                                <input type="text" id="dialogFeeCode" placeholder="例如: FEE001" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div>
                                    <label style="display: block; margin-bottom: 4px; font-weight: bold;">費用:</label>
                                    <input type="number" id="dialogAmount" placeholder="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 4px; font-weight: bold;">教材費:</label>
                                    <input type="number" id="dialogMaterialFee" placeholder="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div>
                                    <label style="display: block; margin-bottom: 4px; font-weight: bold;">時數:</label>
                                    <input type="number" id="dialogHours" placeholder="0" step="0.5" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 4px; font-weight: bold;">拆帳比例 (0-1):</label>
                                    <input type="number" id="dialogSplitRatio" placeholder="0.5" step="0.01" min="0" max="1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                                </div>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 4px; font-weight: bold;">開放課程費用:</label>
                                <input type="number" id="dialogOpenCourseAmount" placeholder="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                            </div>
                        </div>
                        <div id="courseDialogError" class="error" style="display:none; margin-top: 12px;"></div>
                        <div style="margin-top: 20px; display: flex; gap: 8px; justify-content: flex-end;">
                            <button class="btn-default" onclick="closeCourseDialog()">取消</button>
                            <button class="btn-primary" onclick="saveCourse()">儲存</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 新增門禁時間 Tab -->
            <div id="permission" class="tab-content">
                <h3 style="margin-bottom: 16px;">🔑 新增學生門禁時間 (包含課表產生)</h3>
                <div style="padding: 16px 0;">
                    <div style="margin-bottom: 12px;">
                        <label>學生 ID: </label>
                        <input list="studentsDatalist" id="permissionUserId" inputmode="numeric" placeholder="輸入學生 ID" style="width: 260px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                        <datalist id="studentsDatalist">
                            <option value="">請先載入學生列表</option>
                        </datalist>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label>課程: </label>
                        <input list="coursesDatalist" id="permissionCourseId" placeholder="-- 請選擇課程 --" style="width: 260px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                        <datalist id="coursesDatalist">
                            <option value="">請先載入課程列表</option>
                        </datalist>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label>老師 ID: </label>
                        <input list="teachersDatalist" id="permissionTeacherId" inputmode="numeric" placeholder="可留空，預設 0" style="width: 260px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                        <datalist id="teachersDatalist">
                            <option value="0">0 (預設)</option>
                        </datalist>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label>教室 ID: </label>
                        <input type="number" id="permissionClassroomId" placeholder="可留空 (產生課表時使用)" style="width: 260px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label>開始日期: </label>
                        <input type="date" id="permissionStartDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label>結束日期: </label>
                        <input type="date" id="permissionEndDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label>週一: </label>
                        <input type="checkbox" id="permissionMonday" />
                        <label style="margin-left: 12px;">週二: </label>
                        <input type="checkbox" id="permissionTuesday" />
                        <label style="margin-left: 12px;">週三: </label>
                        <input type="checkbox" id="permissionWednesday" />
                        <label style="margin-left: 12px;">週四: </label>
                        <input type="checkbox" id="permissionThursday" />
                        <label style="margin-left: 12px;">週五: </label>
                        <input type="checkbox" id="permissionFriday" />
                        <label style="margin-left: 12px;">週六: </label>
                        <input type="checkbox" id="permissionSaturday" />
                        <label style="margin-left: 12px;">週日: </label>
                        <input type="checkbox" id="permissionSunday" />
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label>開始時間: </label>
                        <input type="time" id="permissionStartTime" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label>結束時間: </label>
                        <input type="time" id="permissionEndTime" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label>類型 (type): </label>
                        <select id="permissionType" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 200px;">
                            <option value="1">1 = 上課</option>
                            <option value="2">2 = 租借教室</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label>課程模式 (courseMode): </label>
                        <select id="permissionCourseMode" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 200px;">
                            <option value="1">1 = 現場</option>
                            <option value="2">2 = 視訊</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label>排課模式 (scheduleMode): </label>
                        <select id="permissionScheduleMode" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 200px;">
                            <option value="1">1 = 每週固定</option>
                            <option value="2">2 = 每兩週固定</option>
                            <option value="3">3 = 單次課程</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label>群組 ID (groupIds): </label>
                        <input type="text" id="permissionGroupIds" placeholder="多個ID用逗號分隔，如: 1,2,3" style="width: 260px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label>備註 (remark): </label>
                        <input type="text" id="permissionRemark" placeholder="可選填" style="width: 260px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                    </div>
                    <button class="btn-primary" onclick="createPermission()">✅ 新增門禁時間</button>
                    <button class="btn-default" onclick="clearPermissionForm()">清除表單</button>
                </div>
                <div id="permissionResult" style="margin-top: 16px;"></div>
                <div id="permissionError" class="error" style="display:none;"></div>
            </div>

            <!-- 學生簽到 Tab -->
            <div id="addattend" class="tab-content">
                <h3 style="margin-bottom: 16px;">✅ 學生簽到（建立 TblAttendance 記錄）</h3>
                <div style="padding: 16px 0;">
                    <div style="margin-bottom: 12px;">
                        <label>學生權限 ID (StudentPermissionId): </label>
                        <input type="number" id="attendStudentPermissionId" min="1" placeholder="輸入學生權限 ID" style="width: 250px;" />
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label>簽到日期: </label>
                        <input type="date" id="attendDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label>簽到類型: </label>
                        <select id="attendType" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 250px;">
                            <option value="1">出席</option>
                            <option value="0">缺席</option>
                            <option value="2">請假</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label>操作者 ID (ModifiedUserId): </label>
                        <input type="number" id="attendModifiedUserId" min="1" placeholder="輸入操作者 ID" style="width: 250px;" />
                    </div>
                    <button class="btn-primary" onclick="createAttendance()">✅ 建立簽到記錄</button>
                    <button class="btn-default" onclick="clearAttendForm()">清除表單</button>
                </div>
                <div id="attendResult" style="margin-top: 16px;"></div>
                <div id="attendError" class="error" style="display:none;"></div>
            </div>

            <!-- 關帳管理 Tab -->
            <div id="closeaccount" class="tab-content">
                <h3 style="margin-bottom: 16px;">📋 關帳管理 - 查詢課表與簽到狀態</h3>

                <!-- 全校課表查詢 -->
                <div style="margin-bottom: 24px; padding: 16px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #409eff;">
                    <h4 style="margin: 0 0 12px 0; color: #0066cc;">🏫 全校課表與簽到狀態</h4>
                    <p style="margin: 0 0 12px 0; color: #666; font-size: 13px;">查詢指定日期的全校課表，顯示每堂課是否已簽到</p>
                    <div style="display: flex; gap: 12px; align-items: flex-end;">
                        <div style="flex: 1;">
                            <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">查詢日期:</label>
                            <input type="date" id="closeAccountDate" value="2025-12-16" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;" />
                        </div>
                        <button class="btn-primary" onclick="getCloseAccountDailyStatus()">🔍 查詢全校課表</button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px;">
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">全部簽到日期:</label>
                            <input type="date" id="checkInAllDate" value="2025-12-16" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;" />
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn-primary" style="width: 100%; background-color: #ff9800;" onclick="checkInAll()">✅ 全部簽到</button>
                        </div>
                    </div>
                    <div id="checkInAllResult" style="margin-top: 12px;"></div>
                    <div id="closeAccountDailyStatus" style="margin-top: 16px;"></div>
                    <div id="closeAccountError" class="error" style="display:none; margin-top: 12px;"></div>
                </div>

                <!-- 取得關帳資料 -->
                <div style="margin-bottom: 24px; padding: 16px; background: #f3e5f5; border-radius: 8px; border-left: 4px solid #9c27b0;">
                    <h4 style="margin: 0 0 12px 0; color: #6a1b9a;">💰 取得關帳資料</h4>
                    <p style="margin: 0 0 12px 0; color: #666; font-size: 13px;">查詢指定日期的關帳記錄，若未全部簽到則提示需完成簽到</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">查詢日期:</label>
                            <input type="date" id="getCloseAccountDate" value="2025-12-16" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;" />
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn-primary" style="width: 100%; background-color: #9c27b0;" onclick="getCloseAccountData()">🔍 取得關帳資料</button>
                        </div>
                    </div>
                    <div id="getCloseAccountResult" style="margin-top: 12px;"></div>
                </div>

                <!-- 新增或編輯關帳 -->
                <div style="margin-bottom: 24px; padding: 16px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #4caf50;">
                    <h4 style="margin: 0 0 12px 0; color: #2e7d32;">💾 新增或編輯關帳</h4>
                    <p style="margin: 0 0 12px 0; color: #666; font-size: 13px;">輸入提存金額，系統自動計算零用金結餘並儲存關帳記錄（若無記錄則新增，若有則更新）</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">關帳日期:</label>
                            <input type="date" id="saveCloseAccountDate" value="2025-12-16" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;" />
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">提存金額:</label>
                            <input type="number" id="saveDepositAmount" min="0" value="0" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;" />
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn-primary" style="width: 100%; background-color: #4caf50;" onclick="saveCloseAccount()">💾 儲存關帳</button>
                        </div>
                    </div>
                    <div id="saveCloseAccountResult" style="margin-top: 12px;"></div>
                </div>

                <!-- 關帳列表查詢 -->
                <div style="margin-bottom: 24px; padding: 16px; background: #fce4ec; border-radius: 8px; border-left: 4px solid #e91e63;">
                    <h4 style="margin: 0 0 12px 0; color: #c2185b;">📋 關帳列表查詢</h4>
                    <p style="margin: 0 0 12px 0; color: #666; font-size: 13px;">查詢指定日期範圍內的所有關帳記錄（若未指定日期，預設查詢最近 30 天）</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">開始日期（可選）:</label>
                            <input type="date" id="listStartDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;" />
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">結束日期（可選）:</label>
                            <input type="date" id="listEndDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;" />
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn-primary" style="width: 100%; background-color: #e91e63;" onclick="getCloseAccountList()">🔍 查詢列表</button>
                        </div>
                    </div>
                    <div id="closeAccountListResult" style="margin-top: 12px;"></div>
                </div>

                <!-- 營業日總表 PDF -->
                <div style="margin-bottom: 24px; padding: 16px; background: #fff3e0; border-radius: 8px; border-left: 4px solid #ff9800;">
                    <h4 style="margin: 0 0 12px 0; color: #e65100;">📄 營業日總表 PDF（假數據版本）</h4>
                    <p style="margin: 0 0 12px 0; color: #666; font-size: 13px;">生成指定日期的營業日總表 PDF，包含統計摘要與學生簽到明細</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label style="display: block; margin-bottom: 4px; font-weight: bold; font-size: 14px;">查詢日期:</label>
                            <input type="date" id="dailyReportDate" value="2025-12-16" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;" />
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn-primary" style="width: 100%;" onclick="getDailyReportPdf()">📥 下載營業日總表 PDF</button>
                        </div>
                    </div>
                    <div id="dailyReportStatus" style="margin-top: 16px;"></div>
                    <div id="dailyReportError" class="error" style="display:none; margin-top: 12px;"></div>
                </div>
            </div>

                <div id="attendResult" style="margin-top: 16px;"></div>
                <div id="attendError" class="error" style="display:none;"></div>
            </div>

            <!-- 添加費用記錄 Tab（可選）-->
            <div id="addfee" class="tab-content" style="display: none;">
                <h3 style="margin-bottom: 16px;">💰 簽到費用記錄（建立 TblAttendanceFee 記錄）</h3>
                <div style="padding: 16px 0;">
                    <div style="margin-bottom: 12px;">
                        <label>簽到記錄 ID (AttendanceId): </label>
                        <input type="number" id="feeAttendanceId" min="1" placeholder="輸入簽到記錄 ID" style="width: 250px;" />
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label>扣課時數 (Hours): </label>
                        <input type="number" id="feeHours" step="0.5" min="0" placeholder="輸入扣課時數" style="width: 250px;" />
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label>單堂學費 (Amount): </label>
                        <input type="number" id="feeAmount" min="0" placeholder="輸入學費金額" style="width: 250px;" />
                    </div>
                    <div style="margin-bottom: 12px;">
                        <label>單堂增減 (AdjustmentAmount): </label>
                        <input type="number" id="feeAdjustment" placeholder="輸入增減金額（負數為減少）" style="width: 250px;" />
                    </div>
                    <button class="btn-primary" onclick="createAttendanceFee()">💰 建立費用記錄</button>
                    <button class="btn-default" onclick="clearFeeForm()">清除表單</button>
                </div>
                <div id="feeResult" style="margin-top: 16px;"></div>
                <div id="feeError" class="error" style="display:none;"></div>
            </div>

            <!-- 查 學生權限 Tab -->
            <div id="attendance" class="tab-content">
                <!-- 依學生ID查詢學生權限 -->
                <div style="margin-bottom: 24px; padding: 16px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #409eff;">
                    <h4 style="margin: 0 0 12px 0;">👤 依學生ID查詢學生權限</h4>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <label>學生 ID：
                            <input type="number" id="queryStudentId" min="1" placeholder="輸入學生 ID" style="width: 150px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" />
                        </label>
                        <button class="btn-primary" onclick="queryStudentPermissions()">查詢學生權限</button>
                        <button class="btn-default" onclick="clearStudentPermissions()">清除</button>
                    </div>
                    <div id="studentPermissionsContent" style="margin-top: 12px;"></div>
                    <div id="studentPermissionsError" class="error" style="display:none;"></div>
                </div>

                <!-- 依學生權限ID查詢費用 -->
                <div style="padding: 16px 0;">
                    <h4 style="margin: 0 0 12px 0;">💰 依學生權限ID查詢費用</h4>
                    <input type="number" id="queryStudentPermissionId" value="1661" min="1" placeholder="輸入學生權限 Id" />
                    <button class="btn-primary" onclick="queryAttendance()">查詢</button>
                    <button class="btn-default" onclick="clearAttendance()">清除</button>
                </div>
                <div id="attendanceContent"></div>
                <div id="attendanceError" class="error" style="display:none;"></div>
                
                <!-- 新增費用記錄區域 -->
                <div style="margin-top: 20px; padding: 16px; background: #f9fafb; border-radius: 8px; border: 1px solid #ddd;">
                    <h4 style="margin-bottom: 12px;">➕ 新增學生權限費用</h4>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <label>學生權限 Id：
                            <input type="number" id="createFeePermissionId" value="1661" min="1" style="width: 150px; padding: 6px;" placeholder="輸入學生權限 Id" />
                        </label>
                        <button class="btn-primary" onclick="createStudentPermissionFee()">新增費用記錄</button>
                    </div>
                    <div style="color: #67c23a; font-size: 13px; margin-top: 8px;">
                        ℹ️ 繳款日將自動設為今天
                    </div>
                    <div id="createFeeResult" style="margin-top: 12px;"></div>
                    <div id="createFeeError" class="error" style="display:none;"></div>
                </div>

                <!-- 修改/刪除費用記錄區域 -->
                <div style="margin-top: 20px; padding: 16px; background: #fff5e6; border-radius: 8px; border: 1px solid #ffe4b5;">
                    <h4 style="margin-bottom: 12px;">✏️ 修改/刪除學生權限費用</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 12px;">
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">學生權限費用 ID：</label>
                            <input type="number" id="updateFeeId" min="1" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;" placeholder="輸入費用 ID" />
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">繳款日期：</label>
                            <input type="date" id="updateFeePaymentDate" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;" />
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; color: #666; margin-bottom: 4px;">總金額：</label>
                            <input type="number" id="updateFeeTotalAmount" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;" placeholder="留空不改" />
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" id="updateFeeIsDelete" />
                            <span style="color: #f56c6c;">刪除此費用記錄</span>
                        </label>
                        <button class="btn-primary" onclick="updateStudentPermissionFee()">更新記錄</button>
                        <button class="btn-default" onclick="clearUpdateFeeForm()">清除</button>
                    </div>
                    <div style="color: #e6a23c; font-size: 13px; margin-top: 8px;">
                        ℹ️ 勾選「刪除」時，系統會執行假刪除，不會真正刪除記錄
                    </div>
                    <div id="updateFeeResult" style="margin-top: 12px;"></div>
                    <div id="updateFeeError" class="error" style="display:none;"></div>
                </div>
                
                <!-- 上課紀錄細項區域 -->
                <div id="attendanceDetailSection" style="display: none; margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd;">
                    <h3 style="color: #667eea;">📋 上課紀錄細項（依序號）</h3>
                    <div id="attendanceDetailContent"></div>
                    <div id="attendanceDetailError" class="error" style="display:none;"></div>
                    <div style="margin-top:20px; padding:12px; background:#f9fafb; border:1px solid #ddd; border-radius:8px;">
                        <h4>✏️ 編輯單堂老師費用</h4>
                        <div style="display:flex; flex-wrap:wrap; gap:12px; margin-top:8px;">
                            <label>簽到ID：<input type="number" id="feeEditAttendanceId" style="width:120px; padding:6px;" /></label>
                            <label>扣課時數：<input type="number" id="feeEditHours" step="0.5" style="width:120px; padding:6px;" placeholder="留空不改" /></label>
                            <label>單堂學費：<input type="number" id="feeEditAmount" style="width:120px; padding:6px;" placeholder="留空=預設拆帳" /></label>
                            <label>單堂增減：<input type="number" id="feeEditAdjust" style="width:120px; padding:6px;" placeholder="留空不改" /></label>
                            <button class="btn-primary btn-small" onclick="updateAttendanceFee()">送出</button>
                        </div>
                        <div id="attendanceFeeResult" style="margin-top:8px;"></div>
                    </div>
                </div>
            </div>

            <!-- 教室列表 Tab -->
            <div id="classrooms" class="tab-content">
                <div style="padding: 16px 0;">
                    <button class="btn-primary" onclick="loadClassrooms()">🔄 載入教室列表</button>
                    <button class="btn-default" onclick="clearClassrooms()">清除</button>
                </div>
                <div id="classroomsContent"></div>
                <div id="classroomsError" class="error" style="display:none;"></div>
            </div>

            <!-- 繳費管理 Tab -->
            <div id="payment" class="tab-content">
                <div class="card">
                    <h3>查詢學生繳費資訊</h3>
                    <div style="padding: 16px 0;">
                        <input type="number" id="paymentStudentPermissionFeeId" value="1" min="1" placeholder="輸入學生權限費用 ID (StudentPermissionFeeId)" />
                        <button class="btn-primary" onclick="getStudentPaymentInfo()">查詢</button>
                        <button class="btn-default" onclick="clearPaymentInfo()">清除</button>
                    </div>
                    <div id="paymentContent"></div>
                    <div id="paymentError" class="error" style="display:none;"></div>
                </div>

                <div class="card">
                    <h3>新增或編輯繳費記錄</h3>
                    <div style="padding: 16px 0; background: #f5f7fa; border-radius: 4px; padding: 12px;">
                        <div style="margin-bottom: 12px;">
                            <label>學生權限費用 ID: <input type="number" id="createPaymentFeeId" value="1" min="1" style="width: 150px;" /></label>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label>繳費金額: <input type="number" id="createPaymentAmount" value="1000" min="1" style="width: 150px;" /></label>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label>折扣金額: <input type="number" id="createPaymentDiscount" value="0" min="0" style="width: 150px;" /></label>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label>備註: <input type="text" id="createPaymentRemark" placeholder="選填" style="width: 250px;" /></label>
                        </div>
                        <div style="color: #67c23a; font-size: 13px; margin-bottom: 8px;">
                            ℹ️ 繳費日期、收據編號與操作者 ID 將自動產生
                        </div>
                        <button class="btn-primary" onclick="createPaymentRecord()">新增記錄</button>
                    </div>
                    <div id="createPaymentResult" style="margin-top: 12px;"></div>
                    <div id="createPaymentError" class="error" style="display:none;"></div>
                </div>
            </div>

            <!-- API 文檔 Tab -->
            <div id="docs" class="tab-content">
                <div style="display: grid; grid-template-columns: 250px 1fr; gap: 20px;">
                    <!-- 左側：API 選單 -->
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                        <h3 style="margin-bottom: 12px; color: #667eea;">API 選單</h3>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="font-weight: bold; color: #667eea; margin-top: 10px; margin-bottom: 5px;">📚 課程管理</div>
                            <button class="btn-primary" style="text-align: left; width: 100%;" onclick="showApiDoc('coursesList')">📖 取得課程列表</button>
                            <button class="btn-primary" style="text-align: left; width: 100%;" onclick="showApiDoc('courseDetail')">📖 取得單一課程</button>
                            <button class="btn-primary" style="text-align: left; width: 100%;" onclick="showApiDoc('createCourse')">➕ 新增課程</button>
                            <button class="btn-primary" style="text-align: left; width: 100%;" onclick="showApiDoc('editCourse')">✏️ 編輯課程</button>
                            <button class="btn-primary" style="text-align: left; width: 100%;" onclick="showApiDoc('copyCourse')">📋 複製課程</button>

                            <div style="font-weight: bold; color: #667eea; margin-top: 10px; margin-bottom: 5px;">💳 繳費管理</div>
                            <button class="btn-primary" style="text-align: left; width: 100%;" onclick="showApiDoc('studentsList')">👨‍🎓 取得學生名單</button>
                            <button class="btn-primary" style="text-align: left; width: 100%;" onclick="showApiDoc('getPaymentInfo')">💳 取得學生繳費資訊</button>
                            <button class="btn-primary" style="text-align: left; width: 100%;" onclick="showApiDoc('createPayment')">💵 新增或編輯繳費記錄</button>

                            <div style="font-weight: bold; color: #667eea; margin-top: 10px; margin-bottom: 5px;">📝 學生權限記錄</div>
                            <button class="btn-primary" style="text-align: left; width: 100%;" onclick="showApiDoc('studentsList')">👨‍🎓 取得學生名單</button>
                            <button class="btn-primary" style="text-align: left; width: 100%;" onclick="showApiDoc('attendanceList')">📝 學生權限記錄列表</button>
                            <button class="btn-primary" style="text-align: left; width: 100%;" onclick="showApiDoc('createPermissionFee')">➕ 新增學生權限費用</button>
                            <button class="btn-primary" style="text-align: left; width: 100%;" onclick="showApiDoc('updatePermissionFee')">✏️ 修改學生權限費用</button>
                            <button class="btn-primary" style="text-align: left; width: 100%;" onclick="showApiDoc('paymentDetail')">💰 顯示繳費細項</button>
                            <button class="btn-primary" style="text-align: left; width: 100%;" onclick="showApiDoc('attendanceFee')">✏️ 單堂老師費用修改</button>

                            <div style="font-weight: bold; color: #667eea; margin-top: 10px; margin-bottom: 5px;">� 關帳管理</div>
                            <button class="btn-primary" style="text-align: left; width: 100%;" onclick="showApiDoc('dailyStatus')">🔍 取得簽到清單</button>
                            <button class="btn-primary" style="text-align: left; width: 100%;" onclick="showApiDoc('checkInAll')">✅ 全部簽到</button>
                            <button class="btn-primary" style="text-align: left; width: 100%;" onclick="showApiDoc('getCloseAccount')">💰 取得關帳資料</button>
                            <button class="btn-primary" style="text-align: left; width: 100%;" onclick="showApiDoc('saveCloseAccount')">💾 新增或編輯關帳</button>
                            <button class="btn-primary" style="text-align: left; width: 100%;" onclick="showApiDoc('listCloseAccount')">📋 取得關帳列表</button>

                            <div style="font-weight: bold; color: #667eea; margin-top: 10px; margin-bottom: 5px;">�📄 報表</div>
                            <button class="btn-primary" style="text-align: left; width: 100%;" onclick="showApiDoc('salaryReport')">📄 薪資明細表</button>
                            <button class="btn-primary" style="text-align: left; width: 100%;" onclick="showApiDoc('companyProfit')">🏢 公司獲利彙總表</button>
                        </div>
                    </div>

                    <!-- 右側：API 文檔內容 -->
                    <div id="apiDocContent" style="padding: 15px;">
                        <div class="info" style="text-align: center; padding: 40px;">
                            👈 請從左側選單選擇要查看的 API
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 選中的資訊 -->
        <div id="selectedInfo" style="display:none;" class="card">
            <div id="selectedContent"></div>
        </div>
    </div>

    <script>
        let teachers = [];
        let students = [];
        let attendanceData = [];
        let selectedTeacher = null;
        let selectedStudent = null;
        let lastDetailPermissionId = null;
        
        // ===== TOKEN 管理 =====
        let authToken = localStorage.getItem('authToken') || null;
        let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');

        // 頁面載入時檢查登入狀態
        window.addEventListener('DOMContentLoaded', () => {
            updateLoginStatus();
        });

        // 統一的 API 請求函數（自動帶 TOKEN）
        async function apiFetch(url, options = {}) {
            const headers = options.headers || {};
            
            // 如果有 TOKEN，自動加入 Authorization header
            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }
            
            // 如果有 body 且是 JSON，設置 Content-Type
            if (options.body && typeof options.body === 'object') {
                headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(options.body);
            }
            
            const fetchOptions = {
                ...options,
                headers
            };
            
            const response = await fetch(url, fetchOptions);
            
            // 如果是 401 未授權，自動登出
            if (response.status === 401) {
                doLogout();
                throw new Error('未授權，請重新登入');
            }
            
            return response;
        }

        // 登入功能
        async function doLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const errorDiv = document.getElementById('loginError');
            const statusDiv = document.getElementById('loginStatus');
            
            if (!username || !password) {
                errorDiv.textContent = '請輸入帳號和密碼';
                errorDiv.style.display = 'block';
                return;
            }
            
            errorDiv.style.display = 'none';
            statusDiv.innerHTML = '<span style="color: #409eff;">🔄 登入中...</span>';
            
            try {
                const res = await apiFetch('/api/v1/User/Login', {
                    method: 'POST',
                    body: {
                        username: username,
                        password: password,
                        locale: "zh-tw", // 0=繁體中文, 1=英文
                        isKeepLogin: true
                    }
                });
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                const data = await res.json();
                
                if (data.result === 1 && data.content && data.content.token) {
                    // 登入成功
                    authToken = data.content.token;
                    currentUser = {
                        userId: data.content.userId,
                        username: data.content.username || username,
                        displayName: data.content.displayName || username
                    };
                    
                    // 儲存到 localStorage
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    updateLoginStatus();
                    
                    errorDiv.style.display = 'none';
                } else {
                    throw new Error(data.msg || '登入失敗');
                }
            } catch (err) {
                authToken = null;
                currentUser = null;
                errorDiv.textContent = '登入失敗: ' + err.message;
                errorDiv.style.display = 'block';
                statusDiv.innerHTML = '<span style="color: #999;">⚠️ 尚未登入</span>';
            }
        }

        // 登出功能
        function doLogout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            
            updateLoginStatus();
        }

        // 更新登入狀態顯示
        function updateLoginStatus() {
            const statusDiv = document.getElementById('loginStatus');
            
            if (authToken && currentUser) {
                statusDiv.innerHTML = `
                    <span style="color: #67c23a; font-weight: bold;">
                        ✅ 已登入: ${currentUser.displayName || currentUser.username}
                        <small style="color: #909399;">(ID: ${currentUser.userId})</small>
                    </span>
                `;
            } else {
                statusDiv.innerHTML = '<span style="color: #999;">⚠️ 尚未登入</span>';
            }
        }

        function switchTab(tabName) {
            // 隱藏所有 tab content
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            // 移除所有 tab 的 active 狀態
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            // 顯示選中的 tab
            document.getElementById(tabName).classList.add('active');
            // 設置對應的 tab 為 active
            event.target.classList.add('active');
        }

        async function loadTeachers() {
            const errorDiv = document.getElementById('teachersError');
            const contentDiv = document.getElementById('teachersContent');
            errorDiv.style.display = 'none';
            contentDiv.innerHTML = '<div class="loading">載入中...</div>';
            
            try {
                const res = await apiFetch('/api/v1/Teachers');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                teachers = data.content || data || [];

                // 填充老師可搜尋選單
                const teacherList = document.getElementById('teachersDatalist');
                teacherList.innerHTML = '<option value="0">0 (預設)</option>';
                teachers.forEach(t => {
                    const id = t.teacherId || t.id;
                    if (id) {
                        const option = document.createElement('option');
                        option.value = id;
                        option.label = `${t.teacherName || t.displayName || ''} (ID: ${id})`;
                        teacherList.appendChild(option);
                    }
                });
                
                if (teachers.length === 0) {
                    contentDiv.innerHTML = '<div class="empty">沒有老師資料</div>';
                } else {
                    let html = '<table><thead><tr><th>ID</th><th>帳號</th><th>名稱</th><th>操作</th></tr></thead><tbody>';
                    teachers.forEach((teacher, index) => {
                        html += `<tr>
                            <td>${teacher.teacherId || teacher.id || '-'}</td>
                            <td>${teacher.userName || '-'}</td>
                            <td>${teacher.teacherName || teacher.displayName || '-'}</td>
                            <td><button class="btn-primary btn-small" onclick="selectTeacher(${index})">選擇</button></td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    contentDiv.innerHTML = html;
                }
            } catch (err) {
                errorDiv.textContent = '載入失敗: ' + err.message;
                errorDiv.style.display = 'block';
                contentDiv.innerHTML = '';
            }
        }

        async function loadStudents() {
            const errorDiv = document.getElementById('studentsError');
            const contentDiv = document.getElementById('studentsContent');
            errorDiv.style.display = 'none';
            contentDiv.innerHTML = '<div class="loading">載入中...</div>';
            
            try {
                const res = await apiFetch('/api/v1/Students');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                students = data.content || data || [];

                // 填充學生可搜尋選單
                const studentList = document.getElementById('studentsDatalist');
                studentList.innerHTML = '<option value="">請選擇學生</option>';
                students.forEach(s => {
                    const id = s.studentId || s.id;
                    if (id) {
                        const option = document.createElement('option');
                        option.value = id;
                        option.label = `${s.studentName || s.displayName || ''} (ID: ${id}, 帳號: ${s.userName || s.username || ''})`;
                        studentList.appendChild(option);
                    }
                });
                
                if (students.length === 0) {
                    contentDiv.innerHTML = '<div class="empty">沒有學生資料</div>';
                } else {
                    let html = '<table><thead><tr><th>ID</th><th>帳號</th><th>名稱</th><th>操作</th></tr></thead><tbody>';
                    students.forEach((student, index) => {
                        html += `<tr>
                            <td>${student.studentId || '-'}</td>
                            <td>${student.userName || '-'}</td>
                            <td>${student.studentName || '-'}</td>
                            <td><button class="btn-primary btn-small" onclick="selectStudent(${index})">選擇</button></td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    contentDiv.innerHTML = html;
                }
            } catch (err) {
                errorDiv.textContent = '載入失敗: ' + err.message;
                errorDiv.style.display = 'block';
                contentDiv.innerHTML = '';
            }
        }

        async function loadCourses() {
            const errorDiv = document.getElementById('coursesError');
            const contentDiv = document.getElementById('coursesContent');
            errorDiv.style.display = 'none';
            contentDiv.innerHTML = '<div class="loading">載入中...</div>';
            
            try {
                const res = await apiFetch('/api/v2/Courses');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const courses = data.content || data || [];
                
                // 更新可搜尋課程清單
                const courseList = document.getElementById('coursesDatalist');
                courseList.innerHTML = '<option value="">-- 請選擇課程 --</option>';
                courses.forEach(course => {
                    const id = course.id || course.courseId;
                    if (id) {
                        const option = document.createElement('option');
                        option.value = id;
                        option.label = `${course.name || course.courseName || ''} (ID: ${id})`;
                        courseList.appendChild(option);
                    }
                });
                
                if (courses.length === 0) {
                    contentDiv.innerHTML = '<div class="empty">沒有課程資料</div>';
                } else {
                    let html = '<table><thead><tr><th>課程 ID</th><th>課程名稱</th><th>課程類型</th><th>收費編號</th><th>費用</th><th>教材費</th><th>時數</th><th>拆帳比例</th><th>操作</th></tr></thead><tbody>';
                    courses.forEach((course) => {
                        const cid = course.id || course.courseId;
                        const cname = (course.name || course.courseName || '').replace(/'/g, "\\'");
                        html += `<tr>
                            <td>${cid || '-'}</td>
                            <td>${course.name || course.courseName || '-'}</td>
                            <td>${course.courseTypeName || '-'}</td>
                            <td>${course.feeCode || '-'}</td>
                            <td>${course.amount !== null && course.amount !== undefined ? '$' + course.amount : '-'}</td>
                            <td>${course.materialFee !== null && course.materialFee !== undefined ? '$' + course.materialFee : '-'}</td>
                            <td>${course.hours !== null && course.hours !== undefined ? course.hours : '-'}</td>
                            <td>${course.splitRatio !== null && course.splitRatio !== undefined ? (course.splitRatio * 100).toFixed(0) + '%' : '-'}</td>
                            <td>
                                ${cid ? `<button class="btn-small btn-primary" onclick="loadCourseDetail(${cid})" style="margin: 2px;">查看</button>` : ''}
                                ${cid ? `<button class="btn-small" onclick="editCourse(${cid})" style="margin: 2px; background: #67c23a; color: white;">編輯</button>` : ''}
                                ${cid ? `<button class="btn-small" onclick="copyCourse(${cid}, '${cname}')" style="margin: 2px; background: #e6a23c; color: white;">複製</button>` : ''}
                                ${cid ? `<button class="btn-small" onclick="deleteCourse(${cid}, '${cname}')" style="margin: 2px; background: #f56c6c; color: white;">刪除</button>` : '<span style="color: #999;">-</span>'}
                            </td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    contentDiv.innerHTML = html;
                }
            } catch (err) {
                errorDiv.textContent = '載入失敗: ' + err.message;
                errorDiv.style.display = 'block';
                contentDiv.innerHTML = '';
            }
        }

        // 取得單一課程（包含收費資料）
        async function loadCourseDetail(courseIdFromRow) {
            const idInput = document.getElementById('singleCourseId');
            const status = document.getElementById('courseDetailStatus');
            const errorDiv = document.getElementById('courseDetailError');
            const contentDiv = document.getElementById('courseDetailContent');

            if (!status || !errorDiv || !contentDiv) {
                console.error('Required DOM elements not found');
                return;
            }

            status.textContent = '';
            errorDiv.style.display = 'none';
            contentDiv.innerHTML = '';

            const courseId = courseIdFromRow ? courseIdFromRow : (idInput && idInput.value ? parseInt(idInput.value, 10) : NaN);
            if (!courseId || isNaN(courseId)) {
                errorDiv.textContent = '請輸入課程 ID';
                errorDiv.style.display = 'block';
                return;
            }
            // 若按下表格中的按鈕，順便同步到輸入框
            if (idInput) {
                idInput.value = courseId;
            }

            try {
                status.textContent = '載入中...';
                const res = await apiFetch(`/api/v2/Course/${courseId}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const course = data.content || data;

                if (!course || !course.courseId) {
                    contentDiv.innerHTML = '<div class="empty">查無課程資料</div>';
                } else {
                    const feeRatio = course.splitRatio !== null && course.splitRatio !== undefined ? (course.splitRatio * 100).toFixed(0) + '%' : '-';
                    contentDiv.innerHTML = `
                        <div class="info" style="line-height:1.8;">
                            <div><strong>課程 ID：</strong>${course.courseId}</div>
                            <div><strong>課程名稱：</strong>${course.courseName || '-'}</div>
                            <div><strong>課程分類：</strong>${course.courseTypeName || '-'}</div>
                            <div><strong>課程類別：</strong>${course.category || '-'}</div>
                            <div><strong>收費編號：</strong>${course.feeCode || '-'}</div>
                            <div><strong>費用：</strong>${course.amount !== null && course.amount !== undefined ? '$' + course.amount : '-'}</div>
                            <div><strong>教材費：</strong>${course.materialFee !== null && course.materialFee !== undefined ? '$' + course.materialFee : '-'}</div>
                            <div><strong>時數：</strong>${course.hours !== null && course.hours !== undefined ? course.hours : '-'}</div>
                            <div><strong>拆帳比例：</strong>${feeRatio}</div>
                            <div><strong>開放課程費用：</strong>${course.openCourseAmount !== null && course.openCourseAmount !== undefined ? '$' + course.openCourseAmount : '-'}</div>
                        </div>`;
                }
                status.textContent = '完成';
            } catch (err) {
                errorDiv.textContent = '載入失敗: ' + err.message;
                errorDiv.style.display = 'block';
                contentDiv.innerHTML = '';
                status.textContent = '';
            }
        }

        function clearCourses() {
            document.getElementById('coursesContent').innerHTML = '';
            document.getElementById('coursesError').style.display = 'none';
            document.getElementById('courseTypesSection').style.display = 'none';
        }

        // 載入課程類型
        async function loadCourseTypes() {
            const sectionDiv = document.getElementById('courseTypesSection');
            const errorDiv = document.getElementById('courseTypesError');
            const contentDiv = document.getElementById('courseTypesContent');
            
            sectionDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            contentDiv.innerHTML = '<div class="loading">載入中...</div>';
            
            try {
                const res = await apiFetch('/api/v1/CourseTypes');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const courseTypes = data.content || data || [];
                
                if (courseTypes.length === 0) {
                    contentDiv.innerHTML = '<div class="empty">沒有課程類型資料</div>';
                } else {
                    let html = '<table><thead><tr><th>類型 ID</th><th>類型名稱</th></tr></thead><tbody>';
                    courseTypes.forEach((type) => {
                        html += `<tr>
                            <td>${type.courseTypeId || '-'}</td>
                            <td>${type.courseTypeName || '-'}</td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    contentDiv.innerHTML = html;
                }
            } catch (err) {
                errorDiv.textContent = '載入失敗: ' + err.message;
                errorDiv.style.display = 'block';
                contentDiv.innerHTML = '';
            }
        }

        // ========== 教室管理功能 ==========
        
        async function loadClassrooms() {
            const errorDiv = document.getElementById('classroomsError');
            const contentDiv = document.getElementById('classroomsContent');
            errorDiv.style.display = 'none';
            contentDiv.innerHTML = '<div class="loading">載入中...</div>';
            
            try {
                const res = await apiFetch('/api/v1/Classrooms');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const classrooms = data.content || data || [];
                
                if (classrooms.length === 0) {
                    contentDiv.innerHTML = '<div class="empty">沒有教室資料</div>';
                } else {
                    let html = '<table><thead><tr><th>教室 ID</th><th>教室名稱</th><th>描述</th></tr></thead><tbody>';
                    classrooms.forEach((classroom) => {
                        html += `<tr>
                            <td>${classroom.classroomId || '-'}</td>
                            <td>${classroom.classroomName || '-'}</td>
                            <td>${classroom.description || '-'}</td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    contentDiv.innerHTML = html;
                }
            } catch (err) {
                errorDiv.textContent = '載入失敗: ' + err.message;
                errorDiv.style.display = 'block';
                contentDiv.innerHTML = '';
            }
        }

        function clearClassrooms() {
            document.getElementById('classroomsContent').innerHTML = '';
            document.getElementById('classroomsError').style.display = 'none';
        }

        // 課程對話框相關函數
        let editingCourseId = null;

        function showAddCourseDialog() {
            editingCourseId = null;
            document.getElementById('courseDialogTitle').textContent = '新增課程';
            document.getElementById('dialogCourseName').value = '';
            document.getElementById('dialogCourseTypeId').value = '';
            document.getElementById('dialogCategory').value = '';
            document.getElementById('dialogSortOrder').value = '500';
            document.getElementById('dialogFeeCode').value = '';
            document.getElementById('dialogAmount').value = '';
            document.getElementById('dialogMaterialFee').value = '';
            document.getElementById('dialogHours').value = '';
            document.getElementById('dialogSplitRatio').value = '';
            document.getElementById('dialogOpenCourseAmount').value = '';
            document.getElementById('courseDialogError').style.display = 'none';
            document.getElementById('courseDialog').style.display = 'flex';
        }

        async function editCourse(courseId) {
            try {
                const res = await apiFetch(`/api/v2/Course/${courseId}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const course = data.content || data;

                editingCourseId = courseId;
                document.getElementById('courseDialogTitle').textContent = '編輯課程';
                document.getElementById('dialogCourseName').value = course.courseName || '';
                document.getElementById('dialogCourseTypeId').value = course.courseTypeId || '';
                document.getElementById('dialogCategory').value = course.category || '';
                document.getElementById('dialogSortOrder').value = course.sortOrder || 500;
                document.getElementById('dialogFeeCode').value = course.feeCode || '';
                document.getElementById('dialogAmount').value = course.amount || '';
                document.getElementById('dialogMaterialFee').value = course.materialFee || '';
                document.getElementById('dialogHours').value = course.hours || '';
                document.getElementById('dialogSplitRatio').value = course.splitRatio || '';
                document.getElementById('dialogOpenCourseAmount').value = course.openCourseAmount || '';
                document.getElementById('courseDialogError').style.display = 'none';
                document.getElementById('courseDialog').style.display = 'flex';
            } catch (err) {
                alert('載入課程資料失敗: ' + err.message);
            }
        }

        function closeCourseDialog() {
            document.getElementById('courseDialog').style.display = 'none';
            editingCourseId = null;
        }

        async function saveCourse() {
            const errorDiv = document.getElementById('courseDialogError');
            errorDiv.style.display = 'none';

            const courseName = document.getElementById('dialogCourseName').value.trim();
            if (!courseName) {
                errorDiv.textContent = '請輸入課程名稱';
                errorDiv.style.display = 'block';
                return;
            }

            const courseData = {
                courseName: courseName,
                courseTypeId: document.getElementById('dialogCourseTypeId').value ? parseInt(document.getElementById('dialogCourseTypeId').value) : null,
                category: document.getElementById('dialogCategory').value || null,
                sortOrder: parseInt(document.getElementById('dialogSortOrder').value) || 500,
                feeCode: document.getElementById('dialogFeeCode').value || null,
                amount: document.getElementById('dialogAmount').value ? parseFloat(document.getElementById('dialogAmount').value) : null,
                materialFee: document.getElementById('dialogMaterialFee').value ? parseFloat(document.getElementById('dialogMaterialFee').value) : null,
                hours: document.getElementById('dialogHours').value ? parseFloat(document.getElementById('dialogHours').value) : null,
                splitRatio: document.getElementById('dialogSplitRatio').value ? parseFloat(document.getElementById('dialogSplitRatio').value) : null,
                openCourseAmount: document.getElementById('dialogOpenCourseAmount').value ? parseFloat(document.getElementById('dialogOpenCourseAmount').value) : null
            };

            try {
                let res;
                if (editingCourseId) {
                    // 更新課程
                    courseData.courseId = editingCourseId;
                    courseData.isDelete = false;
                    res = await apiFetch('/api/v2/UpdateCourse', {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(courseData)
                    });
                } else {
                    // 新增課程
                    res = await apiFetch('/api/v2/Course', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(courseData)
                    });
                }

                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.msg || `HTTP ${res.status}`);
                }

                const data = await res.json();
                if (data.result !== 1) {
                    throw new Error(data.msg || '操作失敗');
                }

                closeCourseDialog();
                alert(editingCourseId ? '更新成功' : '新增成功');
                loadCourses(); // 重新載入列表
            } catch (err) {
                errorDiv.textContent = '儲存失敗: ' + err.message;
                errorDiv.style.display = 'block';
            }
        }

        async function deleteCourse(courseId, courseName) {
            if (!confirm(`確定要刪除課程「${courseName}」嗎？`)) {
                return;
            }

            try {
                const res = await apiFetch('/api/v2/UpdateCourse', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        courseId: courseId,
                        isDelete: true
                    })
                });

                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.msg || `HTTP ${res.status}`);
                }

                const data = await res.json();
                if (data.result !== 1) {
                    throw new Error(data.msg || '刪除失敗');
                }

                alert('刪除成功');
                loadCourses(); // 重新載入列表
            } catch (err) {
                alert('刪除失敗: ' + err.message);
            }
        }

        async function copyCourse(courseId, courseName) {
            const newName = prompt(`請輸入新課程名稱\n（原課程：${courseName}）`, `${courseName} - 副本`);
            if (newName === null) {
                // 使用者按取消
                return;
            }

            // 如果留空，自動加上「- 副本」
            const finalName = newName.trim() ? newName.trim() : `${courseName} - 副本`;

            const newFeeCode = prompt('請輸入新的收費編號（選填，留空則不設定）', '');

            try {
                const res = await apiFetch('/api/v2/CopyCourse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sourceCourseId: courseId,
                        newCourseName: finalName,
                        newFeeCode: newFeeCode || null
                    })
                });

                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.msg || `HTTP ${res.status}`);
                }

                const data = await res.json();
                if (data.result !== 1) {
                    throw new Error(data.msg || '複製失敗');
                }

                alert(`複製成功！新課程 ID: ${data.content?.newCourseId || '未知'}`);
                loadCourses(); // 重新載入列表
            } catch (err) {
                alert('複製失敗: ' + err.message);
            }
        }

        function clearTeachers() {
            document.getElementById('teachersContent').innerHTML = '';
            document.getElementById('teachersError').style.display = 'none';
        }

        function clearStudents() {
            document.getElementById('studentsContent').innerHTML = '';
            document.getElementById('studentsError').style.display = 'none';
        }

        // ========== 學生權限查詢功能 ==========

        async function queryStudentPermissions() {
                    const studentId = document.getElementById('queryStudentId').value;
                    if (!studentId) {
                        alert('請輸入學生 ID');
                        return;
                    }
            
                    const errorDiv = document.getElementById('studentPermissionsError');
                    const contentDiv = document.getElementById('studentPermissionsContent');
                    errorDiv.style.display = 'none';
                    contentDiv.innerHTML = '<div class="loading">查詢中...</div>';
            
                    try {
                        const res = await apiFetch(`/api/v1/StudentPermission/${studentId}`);
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        const data = await res.json();
                
                        if (data.result !== 1 || !data.content) {
                            throw new Error(data.msg || '查詢失敗');
                        }

                        const user = data.content;
                        const permissions = user.studentPermissions || [];
                
                        if (permissions.length === 0) {
                            contentDiv.innerHTML = '<div class="empty">該學生沒有權限記錄</div>';
                            return;
                        }

                        let html = `
                            <div style="margin-bottom: 12px; padding: 12px; background: #e7f3ff; border-radius: 4px;">
                                <strong>學生資訊：</strong>ID: ${user.userId}, 帳號: ${user.username || '-'}, 姓名: ${user.displayName || '-'}
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>權限ID</th>
                                        <th>開始日期</th>
                                        <th>結束日期</th>
                                        <th>時間</th>
                                        <th>星期</th>
                                        <th>群組ID</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;

                        permissions.forEach(perm => {
                            const daysNames = ['日', '一', '二', '三', '四', '五', '六'];
                            const daysText = perm.days ? perm.days.map(d => daysNames[d]).join(', ') : '-';
                            const groupIdsText = perm.groupIds && perm.groupIds.length > 0 ? perm.groupIds.join(', ') : '-';
                    
                            html += `
                                <tr>
                                    <td>${perm.id || '-'}</td>
                                    <td>${perm.datefrom || '-'}</td>
                                    <td>${perm.dateto || '-'}</td>
                                    <td>${perm.timefrom || '-'} ~ ${perm.timeto || '-'}</td>
                                    <td>${daysText}</td>
                                    <td>${groupIdsText}</td>
                                    <td>
                                        <button class="btn-small btn-primary" onclick="document.getElementById('queryStudentPermissionId').value='${perm.id}'; queryAttendance();" style="margin: 2px;">查詢費用</button>
                                    </td>
                                </tr>
                            `;
                        });

                        html += '</tbody></table>';
                        contentDiv.innerHTML = html;
                    } catch (err) {
                        errorDiv.textContent = '查詢失敗: ' + err.message;
                        errorDiv.style.display = 'block';
                        contentDiv.innerHTML = '';
                    }
                }

                function clearStudentPermissions() {
                    document.getElementById('queryStudentId').value = '';
                    document.getElementById('studentPermissionsContent').innerHTML = '';
                    document.getElementById('studentPermissionsError').style.display = 'none';
                }

        async function queryAttendance() {
            const studentPermissionId = document.getElementById('queryStudentPermissionId').value;
            if (!studentPermissionId) {
                alert('請輸入學生權限 Id');
                return;
            }
            
            const errorDiv = document.getElementById('attendanceError');
            const contentDiv = document.getElementById('attendanceContent');
            errorDiv.style.display = 'none';
            contentDiv.innerHTML = '<div class="loading">查詢中...</div>';
            
            // 隱藏細項區域
            document.getElementById('attendanceDetailSection').style.display = 'none';
            
            try {
                const res = await apiFetch(`/api/v1/StudentAttendance/${studentPermissionId}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                
                // 確保 attendanceData 是陣列
                let arrData = data?.content;
                if (!Array.isArray(arrData)) {
                    if (Array.isArray(data)) {
                        arrData = data;
                    } else {
                        arrData = [];
                    }
                }
                attendanceData = arrData;
                
                if (!attendanceData || attendanceData.length === 0) {
                    contentDiv.innerHTML = '<div class="empty">沒有學生權限或費用紀錄</div>';
                } else {
                    let html = '<table><thead><tr><th>序號</th><th>學生權限ID</th><th>StudentPermissionFeeId</th><th>課程名稱</th><th>繳款日</th><th>應收金額</th><th>已收金額</th><th>剩餘欠款</th><th>結帳單號</th><th>課程一</th><th>課程二</th><th>課程三</th><th>課程四</th><th>操作</th></tr></thead><tbody>';
                    attendanceData.forEach(record => {
                        html += `<tr>
                            <td>${record.serialNo || '-'}</td>
                            <td>${record.studentPermissionId || '-'}</td>
                            <td>${(record.studentPermissionFeeId ?? record.StudentPermissionFeeId) || '-'}</td>
                            <td>${record.courseName || '-'}</td>
                            <td>${record.paymentDate || '-'}</td>
                            <td>${record.receivableAmount || '0'}</td>
                            <td>${record.receivedAmount || '0'}</td>
                            <td>${record.outstandingAmount || '0'}</td>
                            <td>${record.receiptNumber || '-'}</td>
                            <td>${record.attendance1 || '-'}</td>
                            <td>${record.attendance2 || '-'}</td>
                            <td>${record.attendance3 || '-'}</td>
                            <td>${record.attendance4 || '-'}</td>
                            <td><button class="btn-primary btn-small" onclick="viewAttendanceDetail(${(record.studentPermissionFeeId ?? record.StudentPermissionFeeId) || 0})">查看細項</button></td>
                        </tr>`;
                    });
                    html += '</tbody></table>';
                    contentDiv.innerHTML = html;
                }
            } catch (err) {
                errorDiv.textContent = '查詢失敗: ' + err.message;
                errorDiv.style.display = 'block';
                contentDiv.innerHTML = '';
            }
        }

        async function viewAttendanceDetail(studentPermissionFeeId) {
            if (!studentPermissionFeeId || studentPermissionFeeId <= 0) {
                alert('無效的學生權限費用 ID');
                return;
            }

            lastDetailPermissionId = studentPermissionFeeId;

            const detailSection = document.getElementById('attendanceDetailSection');
            const detailContent = document.getElementById('attendanceDetailContent');
            const detailError = document.getElementById('attendanceDetailError');
            
            detailSection.style.display = 'block';
            detailContent.innerHTML = '<div class="loading">載入細項中...</div>';
            detailError.style.display = 'none';

            try {
                const res = await apiFetch(`/api/v1/StudentAttendance/Detail/${studentPermissionFeeId}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                
                if (data.result === 1 && data.content) {
                    displayAttendanceDetail(data.content);
                } else {
                    throw new Error(data.msg || '查詢失敗');
                }
            } catch (err) {
                detailError.textContent = '載入細項失敗: ' + err.message;
                detailError.style.display = 'block';
                detailContent.innerHTML = '';
            }
        }

        async function createStudentPermissionFee() {
            const studentPermissionId = parseInt(document.getElementById('createFeePermissionId').value || '0');
            if (!studentPermissionId) {
                alert('請輸入學生權限 Id');
                return;
            }

            const resultDiv = document.getElementById('createFeeResult');
            const errorDiv = document.getElementById('createFeeError');
            resultDiv.innerHTML = '<div class="loading">新增中...</div>';
            errorDiv.style.display = 'none';

            try {
                const res = await apiFetch('/api/v1/StudentAttendance', {
                    method: 'POST',
                    body: { studentPermissionId: studentPermissionId }
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                if (data.result === 1) {
                    resultDiv.innerHTML = `<div class="success">✅ 新增成功！費用 ID: ${data.content?.feeId || '-'}，繳款日: ${data.content?.paymentDate || '-'}</div>`;
                    // 自動重新查詢
                    const queryId = document.getElementById('queryStudentPermissionId').value;
                    if (queryId == studentPermissionId) {
                        setTimeout(() => queryAttendance(), 500);
                    }
                } else {
                    throw new Error(data.msg || '新增失敗');
                }
            } catch (err) {
                errorDiv.textContent = '新增失敗: ' + err.message;
                errorDiv.style.display = 'block';
                resultDiv.innerHTML = '';
            }
        }

        async function updateAttendanceFee() {
            const attendanceId = parseInt(document.getElementById('feeEditAttendanceId').value || '0');
            if (!attendanceId) {
                alert('請輸入簽到ID');
                return;
            }

            const hoursVal = document.getElementById('feeEditHours').value;
            const amountVal = document.getElementById('feeEditAmount').value;
            const adjustVal = document.getElementById('feeEditAdjust').value;

            const payload = { attendanceId };
            if (hoursVal !== '') payload.hours = parseFloat(hoursVal);
            if (amountVal !== '') payload.amount = parseInt(amountVal);
            if (adjustVal !== '') payload.adjustmentAmount = parseInt(adjustVal);

            const resultDiv = document.getElementById('attendanceFeeResult');
            resultDiv.innerHTML = '<div class="loading">送出中...</div>';

            try {
                const res = await apiFetch('/api/v1/StudentAttendance/AttendanceFee', {
                    method: 'PATCH',
                    body: payload
                });

                const data = await res.json();
                if (data.result === 1) {
                    resultDiv.innerHTML = '<div class="success">更新成功</div>';
                    if (lastDetailPermissionId) {
                        viewAttendanceDetail(lastDetailPermissionId);
                    }
                } else {
                    throw new Error(data.msg || '更新失敗');
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="error">更新失敗: ${err.message}</div>`;
            }
        }

        // ===== 修改/刪除學生權限費用記錄 =====
        async function updateStudentPermissionFee() {
            const feeId = parseInt(document.getElementById('updateFeeId').value || '0');
            if (!feeId) {
                alert('請輸入學生權限費用 ID');
                return;
            }

            const paymentDate = document.getElementById('updateFeePaymentDate').value;
            const totalAmount = document.getElementById('updateFeeTotalAmount').value;
            const isDelete = document.getElementById('updateFeeIsDelete').checked;

            const payload = { studentPermissionFeeId: feeId, IsDelete: isDelete };
            if (paymentDate) payload.paymentDate = paymentDate;
            if (totalAmount !== '') payload.totalAmount = parseInt(totalAmount);

            const resultDiv = document.getElementById('updateFeeResult');
            const errorDiv = document.getElementById('updateFeeError');
            resultDiv.innerHTML = '<div class="loading">處理中...</div>';
            errorDiv.style.display = 'none';

            try {
                const res = await apiFetch('/api/v2/StudentAttendance', {
                    method: 'PATCH',
                    body: payload
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                if (data.result === 0) {
                    const action = isDelete ? '刪除' : '更新';
                    resultDiv.innerHTML = `<div class="success">✅ ${action}成功！${data.msg || ''}</div>`;
                    clearUpdateFeeForm();
                    // 自動重新查詢
                    const queryId = document.getElementById('queryStudentPermissionId').value;
                    if (queryId) {
                        setTimeout(() => queryAttendance(), 500);
                    }
                } else {
                    throw new Error(data.msg || '操作失敗');
                }
            } catch (err) {
                errorDiv.textContent = '操作失敗: ' + err.message;
                errorDiv.style.display = 'block';
                resultDiv.innerHTML = '';
            }
        }

        function clearUpdateFeeForm() {
            document.getElementById('updateFeeId').value = '';
            document.getElementById('updateFeePaymentDate').value = '';
            document.getElementById('updateFeeTotalAmount').value = '';
            document.getElementById('updateFeeIsDelete').checked = false;
            document.getElementById('updateFeeResult').innerHTML = '';
            document.getElementById('updateFeeError').style.display = 'none';
        }

        function displayAttendanceDetail(detail) {
            const detailContent = document.getElementById('attendanceDetailContent');
            const formatRatio = (r) => {
                if (r === null || r === undefined) return '-';
                const num = parseFloat(r);
                if (Number.isNaN(num)) return r;
                return (Math.abs(num) <= 1 ? num * 100 : num).toFixed(2) + '%';
            };
            
            let html = `
                <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;">📊 基本資訊</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <div><strong>序號:</strong> ${detail.serialNo || '-'}</div>
                        <div><strong>課程 ID:</strong> ${detail.courseId || '-'}</div>
                        <div><strong>課程名稱:</strong> ${detail.courseName || '-'}</div>
                        <div><strong>課程分類:</strong> ${detail.category || '-'}</div>
                        <div><strong>課程編號:</strong> ${detail.feeCode || '-'}</div>
                        <div><strong>老師 ID:</strong> ${detail.teacherId || '-'}</div>
                        <div><strong>老師名稱:</strong> ${detail.teacherName || '-'}</div>
                        <div><strong>課程總時數:</strong> ${detail.hours || '0'} </div>
                        <div><strong>課程拆帳比:</strong> ${formatRatio(detail.courseSplitRatio)}</div>
                        <div><strong>老師拆帳比:</strong> ${formatRatio(detail.teacherSplitRatio)}</div>
                        <div><strong>使用拆帳比:</strong> ${formatRatio(detail.useSplitRatio)}</div>
                        <div><strong>課程總金額:</strong> $${(detail.totalAmount || 0).toLocaleString()}</div>
                        <div><strong>老師可分得:</strong> $${(detail.totalTeacherAmount || 0).toLocaleString()}</div>
                    </div>
                </div>
            `;

            // 最近一筆收款記錄
            if (detail.payment) {
                const payment = detail.payment;
                html += '<h4 style="margin-top: 20px; margin-bottom: 10px;">💳 最近收款記錄</h4>';
                html += '<table><thead><tr><th>繳費日期</th><th>收款結帳單號</th><th>學費金額</th><th>教材金額</th><th>已收金額</th></tr></thead><tbody>';
                html += `<tr>
                    <td>${payment.paymentDate || '-'}</td>
                    <td>${payment.receiptNumber || '-'}</td>
                    <td>$${(payment.tuitionAmount || 0).toLocaleString()}</td>
                    <td>$${(payment.materialAmount || 0).toLocaleString()}</td>
                    <td><strong>$${(payment.receivedAmount || 0).toLocaleString()}</strong></td>
                </tr>`;
                html += '</tbody></table>';
            } else {
                html += '<div class="info" style="margin-top: 20px;">暫無收款記錄</div>';
            }

            // 課程記錄列表
            if (detail.attendanceRecords && detail.attendanceRecords.length > 0) {
                html += '<h4 style="margin-top: 20px; margin-bottom: 10px;">📅 課程記錄列表</h4>';
                html += '<table><thead><tr><th>簽到ID</th><th>上課日期</th><th>星期幾</th><th>簽到時間</th><th>老師名稱</th><th>扣時數</th><th>單堂學費</th><th>單堂增減</th><th>實際金額</th></tr></thead><tbody>';
                detail.attendanceRecords.forEach(record => {
                    const actualAmount = (record.amount || 0) + (record.adjustmentAmount || 0);
                    const adjustmentStyle = (record.adjustmentAmount || 0) >= 0 ? 'color: green;' : 'color: red;';
                    html += `<tr>
                        <td>${record.attendanceId || '-'}</td>
                        <td>${record.attendanceDate || '-'}</td>
                        <td>${record.dayOfWeek || '-'}</td>
                        <td>${record.checkInTime || '-'}</td>
                        <td>${record.teacherName || '-'}</td>
                        <td>${record.hours || '0'} </td>
                        <td>$${(record.amount || 0).toLocaleString()}</td>
                        <td style="${adjustmentStyle}">${(record.adjustmentAmount || 0) >= 0 ? '+' : ''}$${(record.adjustmentAmount || 0).toLocaleString()}</td>
                        <td><strong>$${actualAmount.toLocaleString()}</strong></td>
                    </tr>`;
                });
                html += '</tbody></table>';
            } else {
                html += '<div class="info" style="margin-top: 20px;">暫無課程記錄</div>';
            }

            detailContent.innerHTML = html;
        }

        function selectTeacher(index) {
            selectedTeacher = teachers[index];
            showSelected();
        }

        function selectStudent(index) {
            selectedStudent = students[index];
            document.getElementById('queryUserId').value = selectedStudent.id;
            // 自動填充門禁表單的學生 ID
            document.getElementById('permissionUserId').value = selectedStudent.id;
            showSelected();
        }

        function showSelected() {
            const infoDiv = document.getElementById('selectedInfo');
            const contentDiv = document.getElementById('selectedContent');
            let html = '';
            
            if (selectedTeacher) {
                html += `<div class="success">✓ 已選擇老師: ${selectedTeacher.teacherName || selectedTeacher.displayName} (帳號: ${selectedTeacher.username})</div>`;
            }
            if (selectedStudent) {
                html += `<div class="info">✓ 已選擇學生: ${selectedStudent.displayName} (帳號: ${selectedStudent.username}, ID: ${selectedStudent.id})</div>`;
            }
            
            if (html) {
                contentDiv.innerHTML = html;
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        }

        function clearTeachers() {
            teachers = [];
            selectedTeacher = null;
            document.getElementById('teachersContent').innerHTML = '<div class="empty">點擊上方按鈕載入老師列表</div>';
            document.getElementById('teachersError').style.display = 'none';
            showSelected();
        }

        function clearStudents() {
            students = [];
            selectedStudent = null;
            document.getElementById('studentsContent').innerHTML = '<div class="empty">點擊上方按鈕載入學生列表</div>';
            document.getElementById('studentsError').style.display = 'none';
            showSelected();
        }

        function clearAttendance() {
            attendanceData = [];
            document.getElementById('attendanceContent').innerHTML = '<div class="empty">輸入學生權限 Id 並點擊查詢</div>';
            document.getElementById('attendanceError').style.display = 'none';
            document.getElementById('createFeeResult').innerHTML = '';
            document.getElementById('createFeeError').style.display = 'none';
        }

        async function createPermission() {
            const userId = document.getElementById('permissionUserId').value;
            const courseId = document.getElementById('permissionCourseId').value;
            const teacherId = document.getElementById('permissionTeacherId').value || 0;
            const classroomId = document.getElementById('permissionClassroomId').value;
            const startDate = document.getElementById('permissionStartDate').value;
            const endDate = document.getElementById('permissionEndDate').value;
            const startTime = document.getElementById('permissionStartTime').value;
            const endTime = document.getElementById('permissionEndTime').value;
            const type = parseInt(document.getElementById('permissionType').value);
            const courseMode = parseInt(document.getElementById('permissionCourseMode').value);
            const scheduleMode = parseInt(document.getElementById('permissionScheduleMode').value);
            const groupIdsStr = document.getElementById('permissionGroupIds').value;
            const remark = document.getElementById('permissionRemark').value;

            // 驗證必填欄位
            if (!userId || !courseId || !startDate || !endDate || !startTime || !endTime) {
                alert('請填寫所有必填欄位');
                return;
            }

            // 取得週幾選項
            const daysOfWeek = [];
            if (document.getElementById('permissionMonday').checked) daysOfWeek.push(1);
            if (document.getElementById('permissionTuesday').checked) daysOfWeek.push(2);
            if (document.getElementById('permissionWednesday').checked) daysOfWeek.push(3);
            if (document.getElementById('permissionThursday').checked) daysOfWeek.push(4);
            if (document.getElementById('permissionFriday').checked) daysOfWeek.push(5);
            if (document.getElementById('permissionSaturday').checked) daysOfWeek.push(6);
            if (document.getElementById('permissionSunday').checked) daysOfWeek.push(0);

            if (daysOfWeek.length === 0) {
                alert('請至少選擇一個星期');
                return;
            }

            // 處理群組 ID
            const groupIds = groupIdsStr ? groupIdsStr.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id)) : [];

            const errorDiv = document.getElementById('permissionError');
            const resultDiv = document.getElementById('permissionResult');
            errorDiv.style.display = 'none';
            resultDiv.innerHTML = '<div class="loading">新增中...</div>';

            // 組合 request body (完整的 UserPermissionDTO)
            const requestBody = {
                userId: parseInt(userId),
                courseId: parseInt(courseId),
                teacherId: parseInt(teacherId) || 0,
                datefrom: startDate.replace(/-/g, '/'),  // 轉換為 YYYY/MM/DD 格式
                dateto: endDate.replace(/-/g, '/'),      // 轉換為 YYYY/MM/DD 格式
                days: daysOfWeek,
                timefrom: startTime,
                timeto: endTime,
                type: type,
                classroomId: classroomId ? parseInt(classroomId) : null,  // 教室ID (可空)
                courseMode: courseMode,      // 課程模式 1=現場 2=視訊
                scheduleMode: scheduleMode,  // 排課模式 1=每週固定 2=每兩週固定 3=單次課程
                groupIds: groupIds,          // 群組IDs
                remark: remark || null       // 備註
            };

            try {
                const res = await apiFetch('/api/v1/StudentPermission', {
                    method: 'POST',
                    body: requestBody
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`HTTP ${res.status}: ${errorText}`);
                }

                const data = await res.json();
                
                // 顯示成功訊息
                let html = '<div class="success"><strong>✅ 新增成功！</strong><br>';
                html += `學生 ID: ${userId}<br>`;
                html += `課程 ID: ${courseId}<br>`;
                html += `老師 ID: ${teacherId || 0}<br>`;
                html += `教室 ID: ${classroomId || '未指定'}<br>`;
                html += `期間: ${startDate} ~ ${endDate}<br>`;
                html += `時間: ${startTime} ~ ${endTime}<br>`;
                html += `星期: ${daysOfWeek.map(d => ['日','一','二','三','四','五','六'][d]).join(', ')}<br>`;
                html += `類型: ${type === 1 ? '上課' : '租借教室'}<br>`;
                html += `課程模式: ${courseMode === 1 ? '現場' : '視訊'}<br>`;
                html += `排課模式: ${scheduleMode === 1 ? '每週固定' : scheduleMode === 2 ? '每兩週固定' : '單次課程'}<br>`;
                if (groupIds.length > 0) html += `群組 ID: ${groupIds.join(', ')}<br>`;
                if (remark) html += `備註: ${remark}<br>`;
                html += '</div>';

                // 如果有回傳資料，顯示詳細資訊
                if (data.content) {
                    html += '<div class="info" style="margin-top: 12px;"><strong>回傳資料:</strong><br>';
                    html += `<pre>${JSON.stringify(data.content, null, 2)}</pre>`;
                    html += '</div>';
                }

                resultDiv.innerHTML = html;
                
                // 清空表單
                setTimeout(() => {
                    if (confirm('是否清空表單？')) {
                        clearPermissionForm();
                    }
                }, 1000);

            } catch (err) {
                errorDiv.textContent = '新增失敗: ' + err.message;
                errorDiv.style.display = 'block';
                resultDiv.innerHTML = '';
            }
        }

        function clearPermissionForm() {
            document.getElementById('permissionUserId').value = '';
            document.getElementById('permissionCourseId').value = '';
            document.getElementById('permissionTeacherId').value = '';
            document.getElementById('permissionClassroomId').value = '';
            document.getElementById('permissionStartDate').value = '';
            document.getElementById('permissionEndDate').value = '';
            document.getElementById('permissionStartTime').value = '';
            document.getElementById('permissionEndTime').value = '';
            document.getElementById('permissionType').value = '1';
            document.getElementById('permissionCourseMode').value = '1';
            document.getElementById('permissionScheduleMode').value = '1';
            document.getElementById('permissionGroupIds').value = '';
            document.getElementById('permissionRemark').value = '';
            
            document.getElementById('permissionMonday').checked = false;
            document.getElementById('permissionTuesday').checked = false;
            document.getElementById('permissionWednesday').checked = false;
            document.getElementById('permissionThursday').checked = false;
            document.getElementById('permissionFriday').checked = false;
            document.getElementById('permissionSaturday').checked = false;
            document.getElementById('permissionSunday').checked = false;
            
            document.getElementById('permissionResult').innerHTML = '';
            document.getElementById('permissionError').style.display = 'none';
        }

        // ===== 學生簽到相關函數 =====

        async function createAttendance() {
            const studentPermissionId = document.getElementById('attendStudentPermissionId').value;
            const attendanceDate = document.getElementById('attendDate').value;
            const attendanceType = document.getElementById('attendType').value;
            const modifiedUserId = document.getElementById('attendModifiedUserId').value;

            if (!studentPermissionId || !attendanceDate || !modifiedUserId) {
                alert('請填入所有必填欄位');
                return;
            }

            const errorDiv = document.getElementById('attendError');
            const resultDiv = document.getElementById('attendResult');
            errorDiv.style.display = 'none';
            resultDiv.innerHTML = '<div class="loading">建立中...</div>';

            const requestBody = {
                studentPermissionId: parseInt(studentPermissionId),
                attendanceDate: attendanceDate,
                attendanceType: parseInt(attendanceType),
                modifiedUserId: parseInt(modifiedUserId)
            };

            try {
                const res = await apiFetch('/api/v1/Attend', {
                    method: 'POST',
                    body: requestBody
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`HTTP ${res.status}: ${errorText}`);
                }

                const data = await res.json();

                let html = '<div class="success"><strong>✅ 簽到成功！</strong><br>';
                html += `學生權限 ID: ${studentPermissionId}<br>`;
                html += `簽到日期: ${attendanceDate}<br>`;
                html += `簽到類型: ${['缺席', '出席', '請假'][attendanceType]}<br>`;
                html += `操作者 ID: ${modifiedUserId}<br>`;
                html += '</div>';

                if (data.content) {
                    html += '<div class="info" style="margin-top: 12px;"><strong>回傳資料:</strong><br>';
                    html += `<pre>${JSON.stringify(data.content, null, 2)}</pre>`;
                    html += '</div>';
                }

                resultDiv.innerHTML = html;

                setTimeout(() => {
                    if (confirm('是否清空表單？')) {
                        clearAttendForm();
                    }
                }, 1000);

            } catch (err) {
                errorDiv.textContent = '建立簽到記錄失敗: ' + err.message;
                errorDiv.style.display = 'block';
                resultDiv.innerHTML = '';
            }
        }

        function clearAttendForm() {
            document.getElementById('attendStudentPermissionId').value = '';
            document.getElementById('attendDate').value = '';
            document.getElementById('attendType').value = '1';
            document.getElementById('attendModifiedUserId').value = '';
            
            document.getElementById('attendResult').innerHTML = '';
            document.getElementById('attendError').style.display = 'none';
        }

        // ========== 關帳管理功能 ==========

        async function getCloseAccountDailyStatus() {
            const date = document.getElementById('closeAccountDate').value;
            if (!date) {
                alert('請選擇查詢日期');
                return;
            }

            const resultDiv = document.getElementById('closeAccountDailyStatus');
            const errorDiv = document.getElementById('closeAccountError');
            resultDiv.innerHTML = '<div class="loading">載入中...</div>';
            errorDiv.style.display = 'none';

            try {
                const res = await apiFetch(`/api/v1/CloseAccount/DailyStatus/${date}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                if (data.result !== 1) {
                    errorDiv.textContent = data.msg || '查詢失敗';
                    errorDiv.style.display = 'block';
                    resultDiv.innerHTML = '';
                    return;
                }

                const content = data.content;
                let html = `
                    <div style="background: white; padding: 12px; border-radius: 4px; margin-bottom: 12px;">
                        <p style="margin: 0 0 8px 0; color: #666;"><strong>查詢日期:</strong> ${content.queryDate}</p>
                        <p style="margin: 0 0 8px 0; color: #666;"><strong>總課堂數:</strong> <span style="color: #0066cc; font-weight: bold;">${content.totalSchedules}</span></p>
                        <p style="margin: 0 0 8px 0; color: #666;"><strong>已簽到:</strong> <span style="color: #28a745; font-weight: bold;">${content.checkedInCount}</span> | <strong>未簽到:</strong> <span style="color: #dc3545; font-weight: bold;">${content.notCheckedInCount}</span></p>
                        <p style="margin: 0 0 0 0; color: #666;"><strong>可以關帳:</strong> <span style="color: ${content.canCloseAccount ? '#28a745' : '#dc3545'}; font-weight: bold;">${content.canCloseAccount ? '✅ 可以' : '❌ 不可以'}</span></p>
                    </div>
                `;

                // 已簽到課程表格
                if (content.checkedInSchedules && content.checkedInSchedules.length > 0) {
                    html += `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #28a745; margin-bottom: 10px;">✅ 已簽到 (${content.checkedInSchedules.length})</h4>
                            <table style="width: 100%; border-collapse: collapse; background: white;">
                                <thead>
                                    <tr style="background: #f0f8f5;">
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">學生編號</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">學生名稱</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">課程名稱</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">教室</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">時間</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    content.checkedInSchedules.forEach(schedule => {
                        html += `
                            <tr style="background: #f9fff9;">
                                <td style="padding: 8px; border: 1px solid #ddd;">${schedule.username}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${schedule.studentName}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${schedule.courseName}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${schedule.classroomName}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${schedule.startTime} ~ ${schedule.endTime}</td>
                            </tr>
                        `;
                    });
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                // 未簽到課程表格
                if (content.notCheckedInSchedules && content.notCheckedInSchedules.length > 0) {
                    html += `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #dc3545; margin-bottom: 10px;">❌ 未簽到 (${content.notCheckedInSchedules.length})</h4>
                            <table style="width: 100%; border-collapse: collapse; background: white;">
                                <thead>
                                    <tr style="background: #fef5f5;">
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">學生編號</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">學生名稱</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">課程名稱</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">教室</th>
                                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">時間</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    content.notCheckedInSchedules.forEach(schedule => {
                        html += `
                            <tr style="background: #fffbfb;">
                                <td style="padding: 8px; border: 1px solid #ddd;">${schedule.username}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${schedule.studentName}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${schedule.courseName}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${schedule.classroomName}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${schedule.startTime} ~ ${schedule.endTime}</td>
                            </tr>
                        `;
                    });
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                resultDiv.innerHTML = html;
            } catch (err) {
                errorDiv.textContent = err.message;
                errorDiv.style.display = 'block';
                resultDiv.innerHTML = '';
            }
        }

        async function getCloseAccountByClassroom() {
            const classroomId = document.getElementById('closeAccountClassroomId').value;
            const date = document.getElementById('closeAccountClassroomDate').value;

            if (!classroomId || !date) {
                alert('請輸入教室ID和查詢日期');
                return;
            }

            const resultDiv = document.getElementById('closeAccountByClassroomStatus');
            const errorDiv = document.getElementById('closeAccountByClassroomError');
            resultDiv.innerHTML = '<div class="loading">載入中...</div>';
            errorDiv.style.display = 'none';

            try {
                const res = await apiFetch(`/api/v1/CloseAccount/Classroom/${classroomId}/DailyStatus/${date}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                if (data.result !== 1) {
                    errorDiv.textContent = data.msg || '查詢失敗';
                    errorDiv.style.display = 'block';
                    resultDiv.innerHTML = '';
                    return;
                }

                const content = data.content;
                let html = `
                    <div style="background: white; padding: 12px; border-radius: 4px; margin-bottom: 12px;">
                        <p style="margin: 0 0 8px 0; color: #666;"><strong>教室:</strong> ${content.classroomName}</p>
                        <p style="margin: 0 0 8px 0; color: #666;"><strong>查詢日期:</strong> ${content.queryDate}</p>
                        <p style="margin: 0 0 8px 0; color: #666;"><strong>總課堂數:</strong> <span style="color: #0066cc; font-weight: bold;">${content.totalSchedules}</span></p>
                        <p style="margin: 0 0 8px 0; color: #666;"><strong>已簽到:</strong> <span style="color: #28a745; font-weight: bold;">${content.checkedInCount}</span> | <strong>未簽到:</strong> <span style="color: #dc3545; font-weight: bold;">${content.notCheckedInCount}</span></p>
                    </div>

                    <table style="width: 100%; border-collapse: collapse; background: white;">
                        <thead>
                            <tr style="background: #f5f7fa;">
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">學生名稱</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">課程名稱</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">時間</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">簽到狀態</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                content.scheduleStatuses.forEach(schedule => {
                    const statusColor = schedule.status === '已簽到' ? '#28a745' : '#dc3545';
                    html += `
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;">${schedule.studentName}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${schedule.courseName}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${schedule.startTime} ~ ${schedule.endTime}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center; color: ${statusColor}; font-weight: bold;">${schedule.status}</td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                `;
                resultDiv.innerHTML = html;
            } catch (err) {
                errorDiv.textContent = err.message;
                errorDiv.style.display = 'block';
                resultDiv.innerHTML = '';
            }
        }

        async function getCloseAccountTeacherStatus() {
            const teacherId = document.getElementById('closeAccountTeacherId').value;
            const date = document.getElementById('closeAccountTeacherDate').value;

            if (!teacherId || !date) {
                alert('請輸入教師ID和查詢日期');
                return;
            }

            const resultDiv = document.getElementById('closeAccountTeacherStatus');
            const errorDiv = document.getElementById('closeAccountTeacherError');
            resultDiv.innerHTML = '<div class="loading">載入中...</div>';
            errorDiv.style.display = 'none';

            try {
                const res = await apiFetch(`/api/v1/CloseAccount/Teacher/${teacherId}/DailyStatus/${date}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                if (data.result !== 1) {
                    errorDiv.textContent = data.msg || '查詢失敗';
                    errorDiv.style.display = 'block';
                    resultDiv.innerHTML = '';
                    return;
                }

                const content = data.content;
                let html = `
                    <div style="background: white; padding: 12px; border-radius: 4px; margin-bottom: 12px;">
                        <p style="margin: 0 0 8px 0; color: #666;"><strong>教師:</strong> ${content.teacherName}</p>
                        <p style="margin: 0 0 8px 0; color: #666;"><strong>查詢日期:</strong> ${content.queryDate}</p>
                        <p style="margin: 0 0 8px 0; color: #666;"><strong>總課堂數:</strong> <span style="color: #0066cc; font-weight: bold;">${content.totalSchedules}</span> | <strong>已簽到:</strong> <span style="color: #28a745; font-weight: bold;">${content.checkedInCount}</span> | <strong>未簽到:</strong> <span style="color: #dc3545; font-weight: bold;">${content.notCheckedInCount}</span></p>
                        <p style="margin: 0 0 0 0; color: #666;"><strong>實收金額:</strong> <span style="color: #ff9800; font-weight: bold;">$${content.totalAmount.toLocaleString()}</span> | <strong>總時數:</strong> <span style="color: #ff9800; font-weight: bold;">${content.totalHours.toFixed(1)}小時</span></p>
                    </div>

                    <table style="width: 100%; border-collapse: collapse; background: white;">
                        <thead>
                            <tr style="background: #f5f7fa;">
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">學生名稱</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">課程名稱</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">時間</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">學費</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">時數</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: center;">簽到狀態</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                content.scheduleStatuses.forEach(schedule => {
                    const statusColor = schedule.isCheckedIn === '已簽到' ? '#28a745' : '#dc3545';
                    html += `
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;">${schedule.studentName}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${schedule.courseName}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${schedule.startTime} ~ ${schedule.endTime}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">$${schedule.amount.toLocaleString()}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${schedule.hours.toFixed(1)}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: center; color: ${statusColor}; font-weight: bold;">${schedule.isCheckedIn}</td>
                        </tr>
                    `;
                });

                html += `
                        </tbody>
                    </table>
                `;
                resultDiv.innerHTML = html;
            } catch (err) {
                errorDiv.textContent = err.message;
                errorDiv.style.display = 'block';
                resultDiv.innerHTML = '';
            }
        }

        async function checkInAll() {
            const date = document.getElementById('checkInAllDate').value;
            if (!date) {
                alert('請選擇全部簽到日期');
                return;
            }

            const resultDiv = document.getElementById('checkInAllResult');
            resultDiv.innerHTML = '<div class="loading">處理中...</div>';

            try {
                const res = await apiFetch(`/api/v1/CloseAccount/CheckInAll/${date}`, {
                    method: 'POST'
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                if (data.result !== 1) {
                    resultDiv.innerHTML = `<div class="error">${data.msg || '操作失敗'}</div>`;
                    return;
                }

                const content = data.content;
                let html = `
                    <div class="success">
                        <strong>✅ 全部簽到完成！</strong><br>
                        <strong>日期:</strong> ${content.date}<br>
                        <strong>總課程數:</strong> ${content.totalSchedules}<br>
                        <strong>成功簽到:</strong> <span style="color: #28a745; font-weight: bold;">${content.successfulCheckins}</span><br>
                        <strong>已簽到總人數:</strong> ${content.checkedInCount}
                    </div>
                `;
                resultDiv.innerHTML = html;
            } catch (err) {
                resultDiv.innerHTML = `<div class="error">操作失敗: ${err.message}</div>`;
            }
        }

        async function getCloseAccountData() {
            const date = document.getElementById('getCloseAccountDate').value;
            if (!date) {
                alert('請選擇查詢日期');
                return;
            }

            const resultDiv = document.getElementById('getCloseAccountResult');
            resultDiv.innerHTML = '<div class="loading">查詢中...</div>';

            try {
                const res = await apiFetch(`/api/v1/CloseAccount/Detail/${date}`, {
                    method: 'GET'
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                if (data.result !== 1) {
                    resultDiv.innerHTML = `<div class="error">${data.msg || '查詢失敗'}</div>`;
                    return;
                }

                const content = data.content;
                
                if (!content) {
                    resultDiv.innerHTML = `
                        <div class="info">
                            <strong>ℹ️ ${data.msg}</strong><br>
                            該日期尚無關帳記錄
                        </div>
                    `;
                    return;
                }

                let html = `
                    <div class="success">
                        <strong>✅ ${data.msg}</strong><br><br>
                        <table style="width: 100%; margin-top: 8px;">
                            <tr>
                                <th style="width: 40%; text-align: left;">項目</th>
                                <th style="width: 60%; text-align: right;">金額 (元)</th>
                            </tr>
                            <tr>
                                <td>關帳日期</td>
                                <td style="text-align: right;">${new Date(content.closeDate).toLocaleDateString('zh-TW')}</td>
                            </tr>
                            <tr>
                                <td>昨日零用金結餘</td>
                                <td style="text-align: right; font-weight: bold;">${content.yesterdayPettyIncome.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>營業收入 (學生學費)</td>
                                <td style="text-align: right; color: #28a745; font-weight: bold;">${content.businessIncome.toLocaleString()}</td>
                            </tr>
                            <tr style="background: #e7f3ff;">
                                <td style="font-weight: bold;">關帳結算金額</td>
                                <td style="text-align: right; color: #0066cc; font-weight: bold; font-size: 16px;">${content.closeAccountAmount.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>提存金額</td>
                                <td style="text-align: right; color: #dc3545; font-weight: bold;">${content.depositAmount.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>零用金結餘</td>
                                <td style="text-align: right; font-weight: bold;">${content.pettyIncome.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>建立時間</td>
                                <td style="text-align: right;">${new Date(content.createdTime).toLocaleString('zh-TW')}</td>
                            </tr>
                            <tr>
                                <td>修改時間</td>
                                <td style="text-align: right;">${new Date(content.modifiedTime).toLocaleString('zh-TW')}</td>
                            </tr>
                        </table>
                    </div>
                `;
                resultDiv.innerHTML = html;
            } catch (err) {
                resultDiv.innerHTML = `<div class="error">查詢失敗: ${err.message}</div>`;
            }
        }

        async function saveCloseAccount() {
            const date = document.getElementById('saveCloseAccountDate').value;
            const depositAmount = parseInt(document.getElementById('saveDepositAmount').value);

            if (!date) {
                alert('請選擇關帳日期');
                return;
            }

            if (isNaN(depositAmount) || depositAmount < 0) {
                alert('請輸入有效的提存金額');
                return;
            }

            const resultDiv = document.getElementById('saveCloseAccountResult');
            resultDiv.innerHTML = '<div class="loading">儲存中...</div>';

            try {
                const res = await apiFetch('/api/v1/CloseAccount', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        date: date,
                        depositAmount: depositAmount
                    })
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                if (data.result !== 1) {
                    resultDiv.innerHTML = `<div class="error">${data.msg || '儲存失敗'}</div>`;
                    return;
                }

                const content = data.content;
                let html = `
                    <div class="success">
                        <strong>✅ ${data.msg}</strong><br><br>
                        <table style="width: 100%; margin-top: 8px;">
                            <tr>
                                <th style="width: 40%; text-align: left;">項目</th>
                                <th style="width: 60%; text-align: right;">金額 (元)</th>
                            </tr>
                            <tr>
                                <td>關帳日期</td>
                                <td style="text-align: right;">${new Date(content.closeDate).toLocaleDateString('zh-TW')}</td>
                            </tr>
                            <tr>
                                <td>昨日零用金結餘</td>
                                <td style="text-align: right; font-weight: bold;">${content.yesterdayPettyIncome.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>營業收入 (學生學費)</td>
                                <td style="text-align: right; color: #28a745; font-weight: bold;">${content.businessIncome.toLocaleString()}</td>
                            </tr>
                            <tr style="background: #e7f3ff;">
                                <td style="font-weight: bold;">關帳結算金額</td>
                                <td style="text-align: right; color: #0066cc; font-weight: bold; font-size: 16px;">${content.closeAccountAmount.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>提存金額</td>
                                <td style="text-align: right; color: #dc3545; font-weight: bold;">${content.depositAmount.toLocaleString()}</td>
                            </tr>
                            <tr style="background: #fff3cd;">
                                <td style="font-weight: bold;">零用金結餘</td>
                                <td style="text-align: right; color: #856404; font-weight: bold; font-size: 16px;">${content.pettyIncome.toLocaleString()}</td>
                            </tr>
                            <tr>
                                <td>建立時間</td>
                                <td style="text-align: right;">${new Date(content.createdTime).toLocaleString('zh-TW')}</td>
                            </tr>
                            <tr>
                                <td>修改時間</td>
                                <td style="text-align: right;">${new Date(content.modifiedTime).toLocaleString('zh-TW')}</td>
                            </tr>
                        </table>
                    </div>
                `;
                resultDiv.innerHTML = html;

                // 更新 getCloseAccountDate 的日期，方便連續操作
                document.getElementById('getCloseAccountDate').value = date;
            } catch (err) {
                resultDiv.innerHTML = `<div class="error">儲存失敗: ${err.message}</div>`;
            }
        }

        async function getCloseAccountList() {
            const startDate = document.getElementById('listStartDate').value;
            const endDate = document.getElementById('listEndDate').value;

            const resultDiv = document.getElementById('closeAccountListResult');
            resultDiv.innerHTML = '<div class="loading">查詢中...</div>';

            try {
                let url = '/api/v1/CloseAccount';
                const params = new URLSearchParams();
                
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }

                const res = await apiFetch(url, {
                    method: 'GET'
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                if (data.result !== 1) {
                    resultDiv.innerHTML = `<div class="error">${data.msg || '查詢失敗'}</div>`;
                    return;
                }

                const content = data.content;
                
                if (!content || content.length === 0) {
                    resultDiv.innerHTML = `
                        <div class="info">
                            <strong>ℹ️ 查無關帳記錄</strong><br>
                            指定日期範圍內沒有關帳記錄
                        </div>
                    `;
                    return;
                }

                let html = `
                    <div class="success">
                        <strong>✅ ${data.msg}</strong>
                    </div>
                    <table style="width: 100%; margin-top: 12px;">
                        <tr>
                            <th style="text-align: center;">關帳日期</th>
                            <th style="text-align: right;">昨日零用金</th>
                            <th style="text-align: right;">營業收入</th>
                            <th style="text-align: right;">關帳結算</th>
                            <th style="text-align: right;">提存金額</th>
                            <th style="text-align: right;">零用金結餘</th>
                            <th style="text-align: center;">修改時間</th>
                        </tr>
                `;

                content.forEach(record => {
                    html += `
                        <tr>
                            <td style="text-align: center; font-weight: bold;">${new Date(record.closeDate).toLocaleDateString('zh-TW')}</td>
                            <td style="text-align: right;">${record.yesterdayPettyIncome.toLocaleString()}</td>
                            <td style="text-align: right; color: #28a745; font-weight: bold;">${record.businessIncome.toLocaleString()}</td>
                            <td style="text-align: right; color: #0066cc; font-weight: bold;">${record.closeAccountAmount.toLocaleString()}</td>
                            <td style="text-align: right; color: #dc3545;">${record.depositAmount.toLocaleString()}</td>
                            <td style="text-align: right; color: #856404; font-weight: bold;">${record.pettyIncome.toLocaleString()}</td>
                            <td style="text-align: center; font-size: 12px;">${new Date(record.modifiedTime).toLocaleDateString('zh-TW')} ${new Date(record.modifiedTime).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'})}</td>
                        </tr>
                    `;
                });

                html += `</table>`;
                resultDiv.innerHTML = html;
            } catch (err) {
                resultDiv.innerHTML = `<div class="error">查詢失敗: ${err.message}</div>`;
            }
        }

        async function getDailyReportPdf() {
            const date = document.getElementById('dailyReportDate').value;
            if (!date) {
                alert('請選擇查詢日期');
                return;
            }

            const resultDiv = document.getElementById('dailyReportStatus');
            const errorDiv = document.getElementById('dailyReportError');
            resultDiv.innerHTML = '<div class="loading">生成 PDF 中...</div>';
            errorDiv.style.display = 'none';

            try {
                const res = await apiFetch(`/api/v1/CloseAccount/DailyReport/${date}`, {
                    method: 'GET'
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `daily-report-${date}.pdf`;
                a.click();
                URL.revokeObjectURL(url);

                resultDiv.innerHTML = `<div class="success">✅ PDF 已生成並下載 <a href="${url}" target="_blank" style="color:#409eff;">預覽</a></div>`;
                setTimeout(() => URL.revokeObjectURL(url), 60000);
            } catch (err) {
                errorDiv.textContent = err.message;
                errorDiv.style.display = 'block';
                resultDiv.innerHTML = '';
            }
        }

        // 費用記錄函數（可選）
        async function createAttendanceFee() {
            const attendanceId = document.getElementById('feeAttendanceId').value;
            const hours = document.getElementById('feeHours').value;
            const amount = document.getElementById('feeAmount').value;
            const adjustmentAmount = document.getElementById('feeAdjustment').value;

            if (!attendanceId || !hours || amount === '') {
                alert('請填入簽到 ID、時數和學費');
                return;
            }

            const errorDiv = document.getElementById('feeError');
            const resultDiv = document.getElementById('feeResult');
            errorDiv.style.display = 'none';
            resultDiv.innerHTML = '<div class="loading">建立中...</div>';

            const requestBody = {
                attendanceId: parseInt(attendanceId),
                hours: parseFloat(hours),
                amount: parseInt(amount),
                adjustmentAmount: parseInt(adjustmentAmount || 0)
            };

            try {
                const res = await apiFetch('/api/v1/AttendanceFee/CreateAttendanceFee', {
                    method: 'POST',
                    body: requestBody
                });

                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`HTTP ${res.status}: ${errorText}`);
                }

                const data = await res.json();

                let html = '<div class="success"><strong>✅ 費用記錄建立成功！</strong><br>';
                html += `簽到 ID: ${attendanceId}<br>`;
                html += `扣課時數: ${hours} <br>`;
                html += `單堂學費: ${amount} 元<br>`;
                html += `增減金額: ${adjustmentAmount || 0} 元<br>`;
                html += `實際金額: ${amount + (parseInt(adjustmentAmount) || 0)} 元`;
                html += '</div>';

                if (data.content) {
                    html += '<div class="info" style="margin-top: 12px;"><strong>回傳資料:</strong><br>';
                    html += `<pre>${JSON.stringify(data.content, null, 2)}</pre>`;
                    html += '</div>';
                }

                resultDiv.innerHTML = html;

                setTimeout(() => {
                    if (confirm('是否清空表單？')) {
                        clearFeeForm();
                    }
                }, 1000);

            } catch (err) {
                errorDiv.textContent = '建立費用記錄失敗: ' + err.message;
                errorDiv.style.display = 'block';
                resultDiv.innerHTML = '';
            }
        }

        function clearFeeForm() {
            document.getElementById('feeAttendanceId').value = '';
            document.getElementById('feeHours').value = '';
            document.getElementById('feeAmount').value = '';
            document.getElementById('feeAdjustment').value = '';
            
            document.getElementById('feeResult').innerHTML = '';
            document.getElementById('feeError').style.display = 'none';
        }

        // 初始化顯示
        clearTeachers();

        // API 文檔切換函數
        function showApiDoc(apiName) {
            const docContent = document.getElementById('apiDocContent');
            let html = '';

            switch(apiName) {
                case 'studentsList':
                    html = `
                        <h2 style="color: #667eea;">👨‍🎓 取得學生名單</h2>
                        <div style="margin-top: 20px;">
                            <h3>📖 API 概述</h3>
                            <p><strong>端點：</strong><code>GET /api/v1/Students</code></p>
                            <p><strong>說明：</strong>取得所有學生的基本資料列表</p>
                            
                            <h3 style="margin-top: 20px;">📥 請求參數</h3>
                            <p>無需參數</p>

                            <h3 style="margin-top: 20px;">📤 回應欄位</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">欄位</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>studentId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">學生 ID</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>userName</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">帳號</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>studentName</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">姓名</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">🧪 測試 API</h3>
                            <button class="btn-primary" onclick="testStudentsList()">執行測試</button>
                            <div id="testResult-studentsList" style="margin-top: 10px;"></div>
                            
                            <h4 style="margin-top: 20px; color: #718096;">📄 RAW DATA</h4>
                            <pre id="rawData-studentsList" style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto; max-height: 400px; font-size: 12px;">執行測試後顯示原始回應資料</pre>
                        </div>
                    `;
                    break;

                case 'attendanceList':
                    html = `
                        <h2 style="color: #667eea;">📝 學生權限記錄列表</h2>
                        <div style="margin-top: 20px;">
                            <h3>📖 API 概述</h3>
                            <p><strong>端點：</strong><code>GET /api/v1/StudentAttendance/{userId}</code></p>
                            <p><strong>說明：</strong>取得指定學生的所有學生權限記錄，包含課程資訊、繳款狀態、出席紀錄摘要</p>

                            <h3 style="margin-top: 20px;">📥 請求參數</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">參數</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">必填</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>studentPermissionId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">✅</td><td style="padding: 8px; border: 1px solid #ddd;">學生權限 ID</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">📤 回應欄位 (ResStudentAttendanceDTO)</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">欄位</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>serialNo</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">序號</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>studentPermissionId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">學生權限 ID</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>studentPermissionFeeId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">學生權限費用 ID</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>courseName</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">課程名稱</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>paymentDate</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">繳款日 (民國年格式: 114/02/27)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>receivableAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">應收金額 (學費+教材)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>receivedAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">已收金額</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>outstandingAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">欠款金額</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>receiptNumber</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">結帳單號</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>attendance1</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">第一筆簽到紀錄摘要</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>attendance2</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">第二筆簽到紀錄摘要</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>attendance3</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">第三筆簽到紀錄摘要</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>attendance4</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">第四筆簽到紀錄摘要</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">🧪 測試 API</h3>
                            <label>學生權限 ID: <input type="number" id="testUserId" value="51" style="width: 150px; padding: 6px;" /></label>
                            <button class="btn-primary" style="margin-top: 10px;" onclick="testAttendanceList()">執行測試</button>
                            <div id="testResult-attendanceList" style="margin-top: 10px;"></div>
                            
                            <h4 style="margin-top: 20px; color: #718096;">📄 RAW DATA</h4>
                            <pre id="rawData-attendanceList" style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto; max-height: 400px; font-size: 12px;">執行測試後顯示原始回應資料</pre>
                        </div>
                    `;
                    break;

                case 'paymentDetail':
                    html = `
                        <h2 style="color: #667eea;">💰 繳費細項</h2>
                        <div style="margin-top: 20px;">
                            <h3>📖 API 概述</h3>
                            <p><strong>端點：</strong><code>GET /api/v1/StudentAttendance/Detail/{studentPermissionFeeId}</code></p>
                            <p><strong>說明：</strong>取得學生權限費用的詳細繳費資訊，包含拆帳比例、老師分潤、課程記錄</p>

                            <h3 style="margin-top: 20px;">📥 請求參數</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">參數</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">必填</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>studentPermissionFeeId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">✅</td><td style="padding: 8px; border: 1px solid #ddd;">學生權限費用 ID</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">📤 回應欄位 (ResPaymentDetailDTO)</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">欄位</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>serialNo</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">序號</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>courseId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">課程 ID</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>courseName</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">課程名稱</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>category</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">類別 (例如: 個別班、團體班等)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>feeCode</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">課程編號</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>teacherId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int?</td><td style="padding: 8px; border: 1px solid #ddd;">老師 ID</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>teacherName</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">老師名稱</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>hours</code></td><td style="padding: 8px; border: 1px solid #ddd;">decimal</td><td style="padding: 8px; border: 1px solid #ddd;">課程總時數</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>courseSplitRatio</code></td><td style="padding: 8px; border: 1px solid #ddd;">decimal</td><td style="padding: 8px; border: 1px solid #ddd;">課程拆帳比例 (0-1；頁面顯示時×100為%)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>teacherSplitRatio</code></td><td style="padding: 8px; border: 1px solid #ddd;">decimal</td><td style="padding: 8px; border: 1px solid #ddd;">老師拆帳比例 (0-1；頁面顯示時×100為%)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>useSplitRatio</code></td><td style="padding: 8px; border: 1px solid #ddd;">decimal</td><td style="padding: 8px; border: 1px solid #ddd;">使用的拆帳比 (min(course, teacher)，0-1；頁面顯示時×100為%)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>totalAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">課程總金額 (學費+教材)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>totalTeacherAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">decimal</td><td style="padding: 8px; border: 1px solid #ddd;">老師可分得金額（可含小數）</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>payment</code></td><td style="padding: 8px; border: 1px solid #ddd;">object?</td><td style="padding: 8px; border: 1px solid #ddd;">最近一筆收款記錄 (PaymentRecordDTO)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>└ paymentDate</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">繳費日期 (民國年格式: 114/11/06)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>└ receiptNumber</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">收款結帳單號</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>└ tuitionAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">學費金額</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>└ materialAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">教材金額</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>└ receivedAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">已收金額 (付款+折扣)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>attendanceRecords</code></td><td style="padding: 8px; border: 1px solid #ddd;">array</td><td style="padding: 8px; border: 1px solid #ddd;">課程記錄列表 (AttendanceRecordDTO[])</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>└ attendanceId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">簽到記錄 ID</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>└ attendanceDate</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">上課日期</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>└ dayOfWeek</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">星期幾</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>└ checkInTime</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">簽到時間 (HH:mm 格式)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>└ teacherName</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">老師名稱</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>└ hours</code></td><td style="padding: 8px; border: 1px solid #ddd;">decimal</td><td style="padding: 8px; border: 1px solid #ddd;">扣課時數</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>└ amount</code></td><td style="padding: 8px; border: 1px solid #ddd;">decimal</td><td style="padding: 8px; border: 1px solid #ddd;">單堂學費（可含小數）</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>└ adjustmentAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">decimal</td><td style="padding: 8px; border: 1px solid #ddd;">單堂增減金額（可含小數）</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">💡 計算邏輯</h3>
                            <div class="info">
                                <p><strong>收款記錄：</strong>只返回最近一筆付款（按 ModifiedTime 降序）</p>
                                <p><strong>已收金額：</strong>付款金額 + 折扣金額</p>
                            </div>

                            <h3 style="margin-top: 20px;">🧪 測試 API</h3>
                            <label>學生權限 ID: <input type="number" id="testPermissionId" value="1661" style="width: 150px; padding: 6px;" /></label>
                            <button class="btn-primary" style="margin-top: 10px;" onclick="testPaymentDetail()">執行測試</button>
                            <div id="testResult-paymentDetail" style="margin-top: 10px;"></div>
                            
                            <h4 style="margin-top: 20px; color: #718096;">📄 RAW DATA</h4>
                            <pre id="rawData-paymentDetail" style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto; max-height: 400px; font-size: 12px;">執行測試後顯示原始回應資料</pre>
                        </div>
                    `;
                    break;

                case 'createPermissionFee':
                    html = `
                        <h2 style="color: #667eea;">➕ 新增學生權限費用</h2>
                        <div style="margin-top: 20px;">
                            <h3>📖 API 概述</h3>
                            <p><strong>端點：</strong><code>POST /api/v1/StudentAttendance</code></p>
                            <p><strong>說明：</strong>為指定的學生權限新增一筆費用記錄，繳款日自動設為今天（系統日期）</p>

                            <h3 style="margin-top: 20px;">📥 請求參數 (ReqCreateStudentPermissionFeeDTO)</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">參數</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">必填</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>studentPermissionId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">✅</td><td style="padding: 8px; border: 1px solid #ddd;">學生權限 ID</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">📤 回應欄位</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">欄位</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>result</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">結果代碼 (1=成功)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>msg</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">訊息</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>content</code></td><td style="padding: 8px; border: 1px solid #ddd;">object?</td><td style="padding: 8px; border: 1px solid #ddd;">成功時的回傳資料</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>└ feeId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">新建立的費用記錄 ID</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>└ paymentDate</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">繳款日 (yyyy/MM/dd 格式)</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">💡 功能說明</h3>
                            <div class="info">
                                <ul style="margin-left: 20px; line-height: 1.8;">
                                    <li><strong>自動設定繳款日：</strong>系統自動將繳款日設為執行當天（UTC+8 時區）</li>
                                    <li><strong>費用分組：</strong>每個學生權限可以有多筆費用記錄，每4筆簽到對應一筆費用</li>
                                    <li><strong>用途：</strong>當學生權限有新的上課週期時，可以新增費用記錄來管理分期繳款</li>
                                </ul>
                            </div>

                            <h3 style="margin-top: 20px;">📝 請求範例</h3>
                            <pre style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto;">POST /api/v1/StudentAttendance
Content-Type: application/json

{
  "studentPermissionId": 1661
}</pre>

                            <h3 style="margin-top: 20px;">✅ 成功回應範例</h3>
                            <pre style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto;">{
  "result": 1,
  "msg": "新增成功",
  "content": {
    "feeId": 123,
    "paymentDate": "2025/12/12"
  }
}</pre>
                        </div>
                    `;
                    break;

                case 'attendanceFee':
                    html = `
                        <h2 style="color: #667eea;">✏️ 單堂老師費用修改</h2>
                        <div style="margin-top: 20px;">
                            <h3>📖 API 概述</h3>
                            <p><strong>端點：</strong><code>PATCH /api/v1/StudentAttendance/AttendanceFee</code></p>
                            <p><strong>說明：</strong>修改指定簽到記錄的費用資訊（扣課時數、單堂學費、單堂增減）</p>

                            <h3 style="margin-top: 20px;">📥 請求參數 (ReqUpdateAttendanceFeeDTO)</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">參數</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">必填</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>attendanceId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">✅</td><td style="padding: 8px; border: 1px solid #ddd;">簽到記錄 ID</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>hours</code></td><td style="padding: 8px; border: 1px solid #ddd;">decimal?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">扣課時數（可空不改）</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>amount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">單堂學費（可空=預設拆帳計算）</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>adjustmentAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">單堂增減（可空不改）</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">📤 回應欄位</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">欄位</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>result</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">結果代碼 (1=成功)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>msg</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">訊息</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">💡 計算邏輯</h3>
                            <div class="info">
                                <p><strong>預設單堂學費計算：</strong></p>
                                <ol style="margin-left: 20px; line-height: 1.8;">
                                    <li>取課程拆帳比 (courseSplitRatio) 和老師拆帳比 (teacherSplitRatio) 的<strong>較小值</strong></li>
                                    <li>老師分潤 = (學費 + 教材) × (1 - 較小拆帳比)</li>
                                    <li>單堂學費 = 老師分潤 ÷ 課程總時數</li>
                                </ol>
                            </div>

                            <h3 style="margin-top: 20px;">📝 請求範例</h3>
                            <pre style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto;">PATCH /api/v1/StudentAttendance/AttendanceFee
Content-Type: application/json

{
  "attendanceId": 456,
  "hours": 1.5,
  "amount": 1200,
  "adjustmentAmount": -100
}</pre>

                            <h3 style="margin-top: 20px;">🧪 測試 API</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                <div><label>簽到 ID: <input type="number" id="testFeeAttendanceId" style="width: 100%; padding: 6px;" /></label></div>
                                <div><label>扣課時數: <input type="number" step="0.5" id="testFeeHours" style="width: 100%; padding: 6px;" placeholder="可空" /></label></div>
                                <div><label>單堂學費: <input type="number" id="testFeeAmount" style="width: 100%; padding: 6px;" placeholder="可空" /></label></div>
                                <div><label>單堂增減: <input type="number" id="testFeeAdjust" style="width: 100%; padding: 6px;" placeholder="可空" /></label></div>
                            </div>
                            <button class="btn-primary" style="margin-top: 10px;" onclick="testAttendanceFee()">執行測試</button>
                            <div id="testResult-attendanceFee" style="margin-top: 10px;"></div>
                            
                            <h4 style="margin-top: 20px; color: #718096;">📄 RAW DATA</h4>
                            <pre id="rawData-attendanceFee" style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto; max-height: 400px; font-size: 12px;">執行測試後顯示原始回應資料</pre>
                        </div>
                    `;
                    break;

                case 'updatePermissionFee':
                    html = `
                        <h2 style="color: #667eea;">✏️ 修改/刪除 學生權限費用記錄</h2>
                        <div style="margin-top: 20px;">
                            <h3>📖 API 概述</h3>
                            <p><strong>端點：</strong><code>PATCH /api/v2/StudentAttendance</code></p>
                            <p><strong>說明：</strong>修改或刪除學生權限費用記錄（可編輯繳款日期、總金額、刪除狀態），方式同 /api/v2/UpdateCourse</p>

                            <h3 style="margin-top: 20px;">📥 請求參數 (ReqUpdateStudentPermissionFeeDTO)</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">參數</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">必填</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>studentPermissionFeeId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">✅</td><td style="padding: 8px; border: 1px solid #ddd;">學生權限費用 ID</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>paymentDate</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">繳款日期（格式: yyyy-MM-dd，可空不改）</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>totalAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">總金額（可空不改）</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>IsDelete</code></td><td style="padding: 8px; border: 1px solid #ddd;">bool</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">刪除標記（true=假刪除，預設 false）</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">📤 回應欄位</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">欄位</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>result</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">結果代碼 (0=成功)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>msg</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">訊息</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">💡 操作邏輯</h3>
                            <div class="info">
                                <p><strong>修改流程：</strong></p>
                                <ol style="margin-left: 20px; line-height: 1.8;">
                                    <li>若 <code>IsDelete = true</code>，執行假刪除（標記為已刪除）</li>
                                    <li>否則，更新 <code>PaymentDate</code>（若提供）和 <code>TotalAmount</code>（若提供）</li>
                                    <li>記錄修改時間 (<code>ModifiedTime</code>)</li>
                                    <li>寫入稽核紀錄</li>
                                </ol>
                            </div>

                            <h3 style="margin-top: 20px;">📝 請求範例</h3>
                            <pre style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto;">// 修改繳款日期和金額
PATCH /api/v2/StudentAttendance
Content-Type: application/json

{
  "studentPermissionFeeId": 123,
  "paymentDate": "2025-12-15",
  "totalAmount": 5000,
  "IsDelete": false
}

// 刪除費用記錄
PATCH /api/v2/StudentAttendance
Content-Type: application/json

{
  "studentPermissionFeeId": 123,
  "IsDelete": true
}</pre>

                            <h3 style="margin-top: 20px;">🧪 測試 API</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                <div><label>費用 ID: <input type="number" id="testUpdateFeeId" style="width: 100%; padding: 6px;" /></label></div>
                                <div><label>繳款日期: <input type="date" id="testUpdatePaymentDate" style="width: 100%; padding: 6px;" /></label></div>
                                <div><label>總金額: <input type="number" id="testUpdateTotalAmount" style="width: 100%; padding: 6px;" placeholder="可空" /></label></div>
                                <div><label>是否刪除: <select id="testUpdateIsDelete" style="width: 100%; padding: 6px;"><option value="false">否</option><option value="true">是</option></select></label></div>
                            </div>
                            <button class="btn-primary" style="margin-top: 10px;" onclick="testUpdateStudentPermissionFee()">執行測試</button>
                            <div id="testResult-updatePermissionFee" style="margin-top: 10px;"></div>
                            
                            <h4 style="margin-top: 20px; color: #718096;">📄 RAW DATA</h4>
                            <pre id="rawData-updatePermissionFee" style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto; max-height: 400px; font-size: 12px;">執行測試後顯示原始回應資料</pre>
                        </div>
                    `;
                    break;

                case 'getPaymentInfo':
                    html = `
                        <h2 style="color: #667eea;">💳 取得學生繳費資訊</h2>
                        <div style="margin-top: 20px;">
                            <h3>📖 API 概述</h3>
                            <p><strong>端點：</strong><code>GET /api/v1/StudentPayment/{studentPermissionFeeId}</code></p>
                            <p><strong>說明：</strong>取得指定學生權限費用的繳費摘要資訊</p>

                            <h3 style="margin-top: 20px;">📥 請求參數</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">參數</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">必填</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>studentPermissionFeeId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">✅</td><td style="padding: 8px; border: 1px solid #ddd;">學生權限 ID</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">📤 回應欄位 (StudentPaymentSummaryDTO)</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">欄位</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>studentPermissionFeeId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">學生權限費用 ID</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>studentPermissionId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">學生權限 ID</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>courseId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int?</td><td style="padding: 8px; border: 1px solid #ddd;">課程 ID</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>courseName</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">課程名稱</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>studentId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int?</td><td style="padding: 8px; border: 1px solid #ddd;">學生 ID</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>studentName</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">學生姓名</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>currentAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">當筆金額 (學費+教材)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>receivableAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">decimal</td><td style="padding: 8px; border: 1px solid #ddd;">應收金額 (扣除總折扣)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>paidAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">已收金額 (最新一筆付款+折扣)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>outstandingAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">decimal</td><td style="padding: 8px; border: 1px solid #ddd;">欠款金額</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>totalDiscount</code></td><td style="padding: 8px; border: 1px solid #ddd;">decimal</td><td style="padding: 8px; border: 1px solid #ddd;">總折扣金額</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>payDate</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">最新繳費日期</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>receiptNumber</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">最新收據編號 (格式: 114B120001)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>remark</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">備註</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">💡 回應說明</h3>
                            <div class="info">
                                <ul style="margin-left: 20px; line-height: 1.8;">
                                    <li><strong>已收金額計算：</strong>最新一筆繳費記錄的付款金額 + 折扣金額</li>
                                    <li><strong>欠款金額：</strong>應收金額 - 已收金額</li>
                                    <li><strong>收據編號格式：</strong>{民國年:03}B{月份:02}{流水號:04}</li>
                                </ul>
                            </div>

                            <h3 style="margin-top: 20px;">🧪 測試 API</h3>
                            <label>學生權限費用 ID: <input type="number" id="testGetPaymentPermissionId" style="width: 150px; padding: 6px;" /></label>
                            <button class="btn-primary" style="margin-top: 10px;" onclick="testGetPaymentInfo()">執行測試</button>
                            <div id="testResult-getPaymentInfo" style="margin-top: 10px;"></div>
                            
                            <h4 style="margin-top: 20px; color: #718096;">📄 RAW DATA</h4>
                            <pre id="rawData-getPaymentInfo" style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto; max-height: 400px; font-size: 12px;">執行測試後顯示原始回應資料</pre>
                        </div>
                    `;
                    break;

                case 'createPayment':
                    html = `
                        <h2 style="color: #667eea;">💵 新增或編輯繳費記錄</h2>
                        <div style="margin-top: 20px;">
                            <h3>📖 API 概述</h3>
                            <p><strong>端點：</strong><code>POST /api/v1/StudentPayment</code></p>
                            <p><strong>說明：</strong>建立或更新繳費記錄（若無則新增，若有則編輯）</p>
                            <div class="info" style="margin-top: 10px; padding: 12px; background: #fffacd; border-left: 4px solid #fbbf24; border-radius: 4px;">
                                <p style="margin: 0;"><strong>⚠️ 智能儲存：</strong></p>
                                <ul style="margin: 8px 0 0 20px; line-height: 1.8;">
                                    <li>若該學生權限尚無繳費記錄 → <strong>新增</strong>記錄（產生收據編號）</li>
                                    <li>若該學生權限已有繳費記錄 → <strong>更新</strong>現有記錄（保留原收據編號）</li>
                                </ul>
                            </div>

                            <h3 style="margin-top: 20px;">📥 請求參數 (ReqCreatePaymentDTO)</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">參數</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">必填</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>studentPermissionFeeId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">✅</td><td style="padding: 8px; border: 1px solid #ddd;">學生權限費用 ID</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>pay</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">✅</td><td style="padding: 8px; border: 1px solid #ddd;">繳費金額</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>discountAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">decimal?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">折扣金額 (預設0)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>remark</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">備註</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">🤖 自動產生欄位</h3>
                            <div class="info">
                                <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #48bb78; color: white;">
                                            <th style="padding: 8px; border: 1px solid #ddd;">欄位</th>
                                            <th style="padding: 8px; border: 1px solid #ddd;">產生規則</th>
                                            <th style="padding: 8px; border: 1px solid #ddd;">範例</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>繳費日期</strong></td><td style="padding: 8px; border: 1px solid #ddd;">系統自動取得當前 UTC+8 時間</td><td style="padding: 8px; border: 1px solid #ddd;">2025/12/10</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>收據編號</strong></td><td style="padding: 8px; border: 1px solid #ddd;">格式: {民國年:03}B{月份:02}{流水號:04}<br/>查詢當月最新流水號後 +1</td><td style="padding: 8px; border: 1px solid #ddd;">114B120091</td></tr>
                                        <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>操作者 ID</strong></td><td style="padding: 8px; border: 1px solid #ddd;">從 JWT Token 的 userId claim 取得</td><td style="padding: 8px; border: 1px solid #ddd;">自動填入</td></tr>
                                    </tbody>
                                </table>
                            </div>

                            <h3 style="margin-top: 20px;">📝 請求範例</h3>
                            <pre style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto;">POST /api/v1/StudentPayment
Content-Type: application/json

{
  "studentPermissionFeeId": 123,
  "pay": 12000,
  "discountAmount": 500,
  "remark": "第一期繳費"
}</pre>

                            <h3 style="margin-top: 20px;">📤 回應欄位</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">欄位</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>result</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">結果代碼 (1=成功)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>msg</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">操作結果：<br/>• <code>created</code> = 新增成功<br/>• <code>updated</code> = 更新成功</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">🧪 測試 API</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                <div><label>學生權限費用 ID: <input type="number" id="testCreatePermissionId" style="width: 100%; padding: 6px;" /></label></div>
                                <div><label>繳費金額: <input type="number" id="testCreatePay" style="width: 100%; padding: 6px;" /></label></div>
                                <div><label>折扣金額: <input type="number" step="0.01" id="testCreateDiscount" value="0" style="width: 100%; padding: 6px;" /></label></div>
                                <div><label>備註: <input type="text" id="testCreateRemark" style="width: 100%; padding: 6px;" placeholder="可選" /></label></div>
                            </div>
                            <button class="btn-primary" style="margin-top: 10px;" onclick="testCreatePayment()">執行測試</button>
                            <div id="testResult-createPayment" style="margin-top: 10px;"></div>
                            
                            <h4 style="margin-top: 20px; color: #718096;">📄 RAW DATA</h4>
                            <pre id="rawData-createPayment" style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto; max-height: 400px; font-size: 12px;">執行測試後顯示原始回應資料</pre>
                        </div>
                    `;
                    break;

                case 'coursesList':
                    html = `
                        <h2 style="color: #667eea;">📖 取得課程列表</h2>
                        <div style="margin-top: 20px;">
                            <h3>📖 API 概述</h3>
                            <p><strong>端點：</strong><code>GET /api/v2/Courses</code></p>
                            <p><strong>說明：</strong>取得所有課程清單，包含課程基本資訊和收費詳情</p>
                            
                            <h3 style="margin-top: 20px;">📥 請求參數</h3>
                            <p>無需參數</p>

                            <h3 style="margin-top: 20px;">📤 回應欄位 (ResCourseDTO[])</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">欄位</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>courseId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">課程 ID</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>courseName</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">課程名稱</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>courseTypeId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int?</td><td style="padding: 8px; border: 1px solid #ddd;">課程類型 ID</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>courseTypeName</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">課程類型名稱</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>category</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">課程類別</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>feeCode</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">收費編號</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>amount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int?</td><td style="padding: 8px; border: 1px solid #ddd;">課程費用</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>materialFee</code></td><td style="padding: 8px; border: 1px solid #ddd;">int?</td><td style="padding: 8px; border: 1px solid #ddd;">教材費</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>hours</code></td><td style="padding: 8px; border: 1px solid #ddd;">decimal?</td><td style="padding: 8px; border: 1px solid #ddd;">課程時數</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>splitRatio</code></td><td style="padding: 8px; border: 1px solid #ddd;">decimal?</td><td style="padding: 8px; border: 1px solid #ddd;">拆帳比例 (0-1)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>openCourseAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int?</td><td style="padding: 8px; border: 1px solid #ddd;">開放課程費用</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">🧪 測試 API</h3>
                            <button class="btn-primary" onclick="testCoursesList()">執行測試</button>
                            <div id="testResult-coursesList" style="margin-top: 10px;"></div>
                            
                            <h4 style="margin-top: 20px; color: #718096;">📄 RAW DATA</h4>
                            <pre id="rawData-coursesList" style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto; max-height: 400px; font-size: 12px;">執行測試後顯示原始回應資料</pre>
                        </div>
                    `;
                    break;

                case 'courseDetail':
                    html = `
                        <h2 style="color: #667eea;">📖 取得單一課程</h2>
                        <div style="margin-top: 20px;">
                            <h3>📖 API 概述</h3>
                            <p><strong>端點：</strong><code>GET /api/v2/Course/{courseId}</code></p>
                            <p><strong>說明：</strong>取得指定課程的詳細資訊，包含收費資料</p>

                            <h3 style="margin-top: 20px;">📥 請求參數</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">參數</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">必填</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>courseId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">✅</td><td style="padding: 8px; border: 1px solid #ddd;">課程 ID (URL 路徑)</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">📤 回應欄位 (ResCourseDTO)</h3>
                            <p>同取得課程列表中的 ResCourseDTO</p>

                            <h3 style="margin-top: 20px;">🧪 測試 API</h3>
                            <label>課程 ID: <input type="number" id="testCourseDetailId" value="1" style="width: 150px; padding: 6px;" /></label>
                            <button class="btn-primary" style="margin-top: 10px;" onclick="testCourseDetail()">執行測試</button>
                            <div id="testResult-courseDetail" style="margin-top: 10px;"></div>
                            
                            <h4 style="margin-top: 20px; color: #718096;">📄 RAW DATA</h4>
                            <pre id="rawData-courseDetail" style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto; max-height: 400px; font-size: 12px;">執行測試後顯示原始回應資料</pre>
                        </div>
                    `;
                    break;

                case 'createCourse':
                    html = `
                        <h2 style="color: #667eea;">➕ 新增課程</h2>
                        <div style="margin-top: 20px;">
                            <h3>📖 API 概述</h3>
                            <p><strong>端點：</strong><code>POST /api/v2/Course</code></p>
                            <p><strong>說明：</strong>新增課程及其收費資訊</p>

                            <h3 style="margin-top: 20px;">📥 請求參數 (ReqNewCourseDTO)</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">參數</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">必填</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>courseName</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">✅</td><td style="padding: 8px; border: 1px solid #ddd;">課程名稱</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>courseTypeId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">課程類型 ID</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>category</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">課程類別</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>sortOrder</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">排序順序 (預設 500)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>feeCode</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">收費編號</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>amount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">課程費用</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>materialFee</code></td><td style="padding: 8px; border: 1px solid #ddd;">int?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">教材費</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>hours</code></td><td style="padding: 8px; border: 1px solid #ddd;">decimal?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">課程時數</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>splitRatio</code></td><td style="padding: 8px; border: 1px solid #ddd;">decimal?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">拆帳比例 (0-1)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>openCourseAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">開放課程費用</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">📝 請求範例</h3>
                            <pre style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto;">POST /api/v2/Course
Content-Type: application/json

{
  "courseName": "小提琴入門班",
  "courseTypeId": 1,
  "category": "個別班",
  "sortOrder": 100,
  "feeCode": "VIO001",
  "amount": 12000,
  "materialFee": 500,
  "hours": 12,
  "splitRatio": 0.35,
  "openCourseAmount": 15000
}</pre>

                            <h3 style="margin-top: 20px;">📤 回應欄位</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">欄位</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>result</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">結果代碼 (1=成功)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>msg</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">訊息</td></tr>
                                </tbody>
                            </table>
                        </div>
                    `;
                    break;

                case 'editCourse':
                    html = `
                        <h2 style="color: #667eea;">✏️ 編輯課程</h2>
                        <div style="margin-top: 20px;">
                            <h3>📖 API 概述</h3>
                            <p><strong>端點：</strong><code>PATCH /api/v2/UpdateCourse</code></p>
                            <p><strong>說明：</strong>更新課程及其收費資訊</p>

                            <h3 style="margin-top: 20px;">📥 請求參數 (ReqUpdateCourseDTO)</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">參數</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">必填</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>courseId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">✅</td><td style="padding: 8px; border: 1px solid #ddd;">課程 ID</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>courseName</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">✅</td><td style="padding: 8px; border: 1px solid #ddd;">課程名稱</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>courseTypeId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">課程類型 ID (可空=不修改)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>isDelete</code></td><td style="padding: 8px; border: 1px solid #ddd;">bool</td><td style="padding: 8px; border: 1px solid #ddd;">✅</td><td style="padding: 8px; border: 1px solid #ddd;">軟刪除標記：<br/>• <code>true</code> = 標記為已刪除，課程將從列表隱藏<br/>• <code>false</code> = 恢復課程顯示<br/>（數據保留在數據庫中，支持恢復）</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>category</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">課程類別 (可空=不修改)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>sortOrder</code></td><td style="padding: 8px; border: 1px solid #ddd;">int?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">排序順序 (可空=不修改)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>feeCode</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">收費編號 (可空=不修改)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>amount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">課程費用 (可空=不修改)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>materialFee</code></td><td style="padding: 8px; border: 1px solid #ddd;">int?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">教材費 (可空=不修改)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>hours</code></td><td style="padding: 8px; border: 1px solid #ddd;">decimal?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">課程時數 (可空=不修改)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>splitRatio</code></td><td style="padding: 8px; border: 1px solid #ddd;">decimal?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">拆帳比例 0-1 (可空=不修改)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>openCourseAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">開放課程費用 (可空=不修改)</td></tr>
                                </tbody>
                            </table>

                                    <h3 style="margin-top: 20px;">💡 操作邏輯</h3>
                                    <div class="info">
                                        <p><strong>修改流程：</strong></p>
                                        <ol style="margin-left: 20px; line-height: 1.8;">
                                            <li>若 <code>isDelete = true</code>，執行假刪除（標記為已刪除）</li>
                                            <li>否則，更新 <code>PaymentDate</code>（若提供）和 <code>TotalAmount</code>（若提供）</li>
                                            <li>記錄修改時間 (<code>ModifiedTime</code>)</li>
                                            <li>寫入稽核紀錄</li>
                                        </ol>
                                    </div>

                            <h3 style="margin-top: 20px;">📝 請求範例</h3>
                            <pre style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto;">PATCH /api/v2/UpdateCourse
Content-Type: application/json

{
  "courseId": 15,
  "courseName": "小提琴進階班",
  "courseTypeId": 1,
  "isDelete": false,
  "category": "團體班",
  "sortOrder": 150,
  "amount": 15000,
  "materialFee": 800,
  "hours": 16,
  "splitRatio": 0.40
}</pre>

                            <h3 style="margin-top: 20px;">📤 回應欄位</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">欄位</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>result</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">結果代碼 (1=成功)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>msg</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">訊息</td></tr>
                                </tbody>
                            </table>
                        </div>
                    `;
                    break;

                case 'copyCourse':
                    html = `
                        <h2 style="color: #667eea;">📋 複製課程</h2>
                        <div style="margin-top: 20px;">
                            <h3>📖 API 概述</h3>
                            <p><strong>端點：</strong><code>POST /api/v2/CopyCourse</code></p>
                            <p><strong>說明：</strong>複製指定課程及其收費資訊，生成新課程</p>

                            <h3 style="margin-top: 20px;">📥 請求參數 (ReqCopyCourseDTO)</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">參數</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">必填</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>sourceCourseId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">✅</td><td style="padding: 8px; border: 1px solid #ddd;">來源課程 ID</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>newCourseName</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">新課程名稱 (留空則自動加「- 副本」)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>newFeeCode</code></td><td style="padding: 8px; border: 1px solid #ddd;">string?</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">新的收費編號 (可空)</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">📤 回應欄位</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">欄位</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>result</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">結果代碼 (1=成功)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>msg</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">訊息</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>content.newCourseId</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">新建課程的 ID</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">💡 複製內容</h3>
                            <div class="info">
                                <ul style="margin-left: 20px; line-height: 1.8;">
                                    <li><strong>課程基本資訊：</strong>名稱、類型、啟用狀態</li>
                                    <li><strong>收費資訊：</strong>類別、排序、金額、教材費、時數、拆帳比例、開放課程費用</li>
                                    <li><strong>新課程名稱：</strong>若留空自動生成為「來源課程名稱 - 副本」</li>
                                </ul>
                            </div>

                            <h3 style="margin-top: 20px;">📝 請求範例</h3>
                            <pre style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto;">POST /api/v2/CopyCourse
Content-Type: application/json

{
  "sourceCourseId": 15,
  "newCourseName": "小提琴進階班 - 週末班",
  "newFeeCode": "VIO002"
}</pre>
                        </div>
                    `;
                    break;

                case 'salaryReport':
                    html = `
                        <h2 style="color: #667eea;">📄 薪資明細表 </h2>
                        <div style="margin-top: 20px;">
                            <h3>📖 API 概述</h3>
                            <p><strong>端點:</strong><code>GET /api/pdf/v1/SalaryReport?startDate={yyyy-MM-dd}&endDate={yyyy-MM-dd}&teacherId={id}&includePaid={bool}</code></p>
                            <p><strong>控制器:</strong><code>PDFController</code></p>
                            <p><strong>說明:</strong>依結算日期區間、老師 ID 產生薪資明細表 PDF，資料來源為簽到(tblAttendance)與簽到費用(tblAttendanceFee)。可選擇是否包含未繳費記錄。</p>

                            <h3 style="margin-top: 20px;">📥 查詢參數</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">參數</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">必填</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;">startDate</td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">✅</td><td style="padding: 8px; border: 1px solid #ddd;">結算日期起始 (格式: yyyy-MM-dd)，例如 2025-12-01</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;">endDate</td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">✅</td><td style="padding: 8px; border: 1px solid #ddd;">結算日期結束 (格式: yyyy-MM-dd)，例如 2025-12-31</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;">teacherId</td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">✅</td><td style="padding: 8px; border: 1px solid #ddd;">指定老師 ID</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;">includePaid</td><td style="padding: 8px; border: 1px solid #ddd;">bool</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">沒繳學費是否要計薪 (預設 true=包含未繳費; false=僅已繳費)</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">🧪 測試 API</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                <div><label>結算日期起始: <input type="date" id="testSalaryStartDate" value="2025-12-01" style="width: 100%; padding: 6px;" /></label></div>
                                <div><label>結算日期結束: <input type="date" id="testSalaryEndDate" value="2025-12-31" style="width: 100%; padding: 6px;" /></label></div>
                                <div><label>老師 ID: <input type="number" id="testSalaryTeacherId" value="2" style="width: 100%; padding: 6px;" /></label></div>
                                <div>
                                    <label>未繳費計薪: 
                                        <select id="testSalaryIncludePaid" style="width: 100%; padding: 6px;">
                                            <option value="true">是 (包含)</option>
                                            <option value="false">否 (排除)</option>
                                        </select>
                                    </label>
                                </div>
                            </div>
                            <button class="btn-primary" style="margin-top: 10px;" onclick="testSalaryReport()">執行測試 (下載 PDF)</button>
                            <div id="testResult-salaryReport" style="margin-top: 10px;"></div>

                            <h3 style="margin-top: 20px;">💡 操作邏輯</h3>
                            <div style="background: #f0f9ff; border-left: 4px solid #667eea; padding: 12px; border-radius: 4px; margin-top: 10px;">
                                <ol style="margin-left: 20px; color: #333;">
                                    <li><strong>查詢簽到資料:</strong> 根據 teacherId 和日期區間 [startDate, endDate] 查詢 tblAttendance，帶出 AttendanceFee、StudentPermission、Course、StudentPermissionFees 及 Payment。</li>
                                    <li><strong>篩選條件:</strong>
                                        <ul style="margin-left: 20px;">
                                            <li>排除 IsDelete=true 的出勤、權限、費用記錄</li>
                                            <li>簽到日期必須在查詢區間內</li>
                                            <li>該 StudentPermission 必須有至少一筆未刪除的 StudentPermissionFee</li>
                                        </ul>
                                    </li>
                                    <li><strong>分組計算:</strong> 每個 StudentPermission 的簽到記錄依日期排序，按每 4 筆為一組 (feeGroupIndex = attendanceIndex / 4) 對應該組的 StudentPermissionFee。</li>
                                    <li><strong>繳費篩選:</strong> 若 includePaid=false，則只保留該組 StudentPermissionFee 有繳款 (Payment.Pay &gt; 0) 的記錄。</li>
                                    <li><strong>金額計算:</strong> 薪資金額 = AttendanceFee.Amount + AttendanceFee.AdjustmentAmount；時數預設 1 小時（若 AttendanceFee.Hours &gt; 0 則用其值）。</li>
                                    <li><strong>學生聚合:</strong> 依 StudentPermission.UserId 聚合，統計該學生的堂數、總時數、總金額。</li>
                                    <li><strong>期間格式:</strong> 轉換為民國年月 (ROC year) 格式，例如 "115/12" 代表 2025 年 12 月。</li>
                                    <li><strong>PDF 生成:</strong> 調用 QuestPDF 依老師名稱、期間、學生清單（序號、姓名、樂器、各堂金額/時數、合計）生成表格，最後加上老師拆帳比、小計、總時數、總堂數資訊。</li>
                                </ol>
                            </div>

                            <h4 style="margin-top: 20px; color: #718096;">📄 RAW DATA</h4>
                            <pre id="rawData-salaryReport" style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto; max-height: 400px; font-size: 12px;">執行測試後顯示檔案資訊</pre>
                        </div>
                    `;
                    break;

                case 'companyProfit':
                    html = `
                        <h2 style="color: #667eea;">🏢 公司獲利彙總表 </h2>
                        <div style="margin-top: 20px;">
                            <h3>📖 API 概述</h3>
                            <p><strong>端點:</strong><code>GET /api/pdf/v1/CompanyProfitSummary?startDate={yyyy-MM-dd}&endDate={yyyy-MM-dd}&teacherId={id}&includePaid={bool}</code></p>
                            <p><strong>控制器:</strong><code>PDFController</code></p>
                            <p><strong>說明:</strong>依結算日期區間產生公司獲利彙總表 PDF，按老師分組統計。實收學費由薪資回推拆帳比金額，薪資直接加總 tblAttendance，毛利為實收減薪資。</p>

                            <h3 style="margin-top: 20px;">📥 查詢參數</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #667eea; color: white;">
                                        <th style="padding: 8px; border: 1px solid #ddd;">參數</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">必填</th>
                                        <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;">startDate</td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">✅</td><td style="padding: 8px; border: 1px solid #ddd;">結算日期起始 (格式: yyyy-MM-dd)，例如 2025-10-01</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;">endDate</td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">✅</td><td style="padding: 8px; border: 1px solid #ddd;">結算日期結束 (格式: yyyy-MM-dd)，例如 2025-10-31</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;">teacherId</td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">✅</td><td style="padding: 8px; border: 1px solid #ddd;">指定老師 ID</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;">includePaid</td><td style="padding: 8px; border: 1px solid #ddd;">bool</td><td style="padding: 8px; border: 1px solid #ddd;">❌</td><td style="padding: 8px; border: 1px solid #ddd;">沒繳學費是否要計薪 (預設 true=包含未繳費; false=僅已繳費)</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">🧪 測試 API</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                                <div><label>結算日期起始: <input type="date" id="testProfitStartDate" value="2025-12-01" style="width: 100%; padding: 6px;" /></label></div>
                                <div><label>結算日期結束: <input type="date" id="testProfitEndDate" value="2025-12-31" style="width: 100%; padding: 6px;" /></label></div>
                                <div><label>老師 ID: <input type="number" id="testProfitTeacherId" value="2" style="width: 100%; padding: 6px;" /></label></div>
                                <div>
                                    <label>未繳費計薪: 
                                        <select id="testProfitIncludePaid" style="width: 100%; padding: 6px;">
                                            <option value="true">是 (包含)</option>
                                            <option value="false">否 (排除)</option>
                                        </select>
                                    </label>
                                </div>
                            </div>
                            <button class="btn-primary" style="margin-top: 10px;" onclick="testCompanyProfit()">執行測試 (下載 PDF)</button>
                            <div id="testResult-companyProfit" style="margin-top: 10px;"></div>

                            <h3 style="margin-top: 20px;">💡 操作邏輯</h3>
                            <div style="background: #f0f9ff; border-left: 4px solid #667eea; padding: 12px; border-radius: 4px; margin-top: 10px;">
                                <ol style="margin-left: 20px; color: #333;">
                                    <li><strong>查詢出勤資料:</strong> 根據 teacherId 和日期區間 [startDate, endDate] 查詢 tblAttendance，帶出 AttendanceFee、StudentPermission、Teacher、TeacherSettlement、Course、StudentPermissionFees 及 Payment。</li>
                                    <li><strong>篩選條件:</strong>
                                        <ul style="margin-left: 20px;">
                                            <li>排除 IsDelete=true 的出勤、權限、費用記錄</li>
                                            <li>出勤日期必須在查詢區間內</li>
                                            <li>該 StudentPermission 必須有至少一筆未刪除的 StudentPermissionFee</li>
                                        </ul>
                                    </li>
                                    <li><strong>分組對應:</strong> 同薪資明細，每 StudentPermission 的簽到依日期排序，按每 4 筆分為一組去對應該組的 StudentPermissionFee。</li>
                                    <li><strong>繳費判定:</strong> 若 includePaid=false，只計算有繳款 (StudentPermissionFee.Payment.Pay &gt; 0) 的出勤。</li>
                                    <li><strong>實收學費計算:</strong> 使用 AttendanceFee.SourceHoursTotalAmount 作為該筆出勤的「實收學費」。</li>
                                    <li><strong>薪資類型區分:</strong> 若對應組有付款，該筆薪資 (Amount + AdjustmentAmount) 計入「應付薪資」；否則計入「補發薪資」。</li>
                                    <li><strong>欠費計算:</strong> 課程定價 = Course.CourseFee.Amount + Course.CourseFee.MaterialFee；實收 = 該 StudentPermission 所有有付款 (Payment) 的 StudentPermissionFee 的 Pay + DiscountAmount 之和；欠費 = Max(定價 - 實收, 0)，每個 StudentPermission 只計算一次。</li>
                                    <li><strong>老師聚合:</strong> 依 TeacherId 分組統計:
                                        <ul style="margin-left: 20px;">
                                            <li>學生數 = 不重複的 StudentIds 數量</li>
                                            <li>堂數 = 累計 AttendanceFee.Hours（預設 1）</li>
                                            <li>實收學費 = 累計 SourceHoursTotalAmount</li>
                                            <li>折帳薪資 = 累計 Amount + AdjustmentAmount（全部）</li>
                                            <li>應付薪資 = 有付款組的薪資總和</li>
                                            <li>補發薪資 = 未付款組的薪資總和</li>
                                            <li>學費欠費 = 累計各 StudentPermission 的欠費</li>
                                        </ul>
                                    </li>
                                    <li><strong>毛利計算:</strong> 公司毛利 = 實收學費 - 折帳薪資；毛利率 = (毛利 / 實收學費) × 100%。</li>
                                    <li><strong>PDF 生成:</strong> 調用 QuestPDF 生成表格，欄位包括序號、老師名稱、學生數、堂數、學費欠費、實收學費、折帳薪資、應付薪資、補發薪資、公司毛利、毛利率，最後加上合計行。</li>
                                </ol>
                            </div>

                            <h4 style="margin-top: 20px; color: #718096;">📄 RAW DATA</h4>
                            <pre id="rawData-companyProfit" style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto; max-height: 400px; font-size: 12px;">執行測試後顯示檔案資訊</pre>
                        </div>
                    `;
                    break;

                case 'dailyStatus':
                    html = `
                        <h2 style="color: #667eea;">🔍 取得簽到清單（包含檢查可以關帳）</h2>
                        <div style="margin-top: 20px;">
                            <h3>📖 API 概述</h3>
                            <p><strong>端點：</strong><code>GET /api/v1/CloseAccount/DailyStatus/{date}</code></p>
                            <p><strong>說明：</strong>查詢指定日期的全校課表，顯示每堂課的簽到狀態，並檢查是否可以關帳</p>

                            <h3 style="margin-top: 20px;">📥 請求參數</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead><tr style="background: #667eea; color: white;">
                                    <th style="padding: 8px; border: 1px solid #ddd;">參數</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                </tr></thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>date</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">查詢日期 (格式: yyyy-MM-dd)</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">📤 回應欄位</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead><tr style="background: #667eea; color: white;">
                                    <th style="padding: 8px; border: 1px solid #ddd;">欄位</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                </tr></thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>queryDate</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">查詢日期</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>totalSchedules</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">總課堂數</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>checkedInCount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">已簽到數</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>notCheckedInCount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">未簽到數</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>canCloseAccount</code></td><td style="padding: 8px; border: 1px solid #ddd;">bool</td><td style="padding: 8px; border: 1px solid #ddd;">是否可以關帳 (全部簽到時為 true)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>checkedInSchedules[]</code></td><td style="padding: 8px; border: 1px solid #ddd;">object[]</td><td style="padding: 8px; border: 1px solid #ddd;">已簽到課程列表</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>notCheckedInSchedules[]</code></td><td style="padding: 8px; border: 1px solid #ddd;">object[]</td><td style="padding: 8px; border: 1px solid #ddd;">未簽到課程列表</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">💡 說明</h3>
                            <div class="info">
                                <ul style="margin-left: 20px; line-height: 1.8;">
                                    <li>查詢指定日期的全校課表（只查學生類型的課表）</li>
                                    <li>對每堂課查詢是否有簽到記錄</li>
                                    <li>若全部課程都已簽到，則 <code>canCloseAccount = true</code></li>
                                    <li>課程列表包含學生編號、學生名稱、課程名稱、教室、上下課時間</li>
                                </ul>
                            </div>
                        </div>
                    `;
                    break;

                case 'checkInAll':
                    html = `
                        <h2 style="color: #667eea;">✅ 全部簽到</h2>
                        <div style="margin-top: 20px;">
                            <h3>📖 API 概述</h3>
                            <p><strong>端點：</strong><code>POST /api/v1/CloseAccount/CheckInAll/{date}</code></p>
                            <p><strong>說明：</strong>為指定日期的所有未簽到課程一鍵簽到，並同時建立對應的 AttendanceFee 記錄</p>

                            <h3 style="margin-top: 20px;">📥 請求參數</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead><tr style="background: #667eea; color: white;">
                                    <th style="padding: 8px; border: 1px solid #ddd;">參數</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                </tr></thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>date</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">簽到日期 (格式: yyyy-MM-dd)</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">📤 回應欄位</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead><tr style="background: #667eea; color: white;">
                                    <th style="padding: 8px; border: 1px solid #ddd;">欄位</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                </tr></thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>date</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">簽到日期</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>totalSchedules</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">總課堂數</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>successfulCheckins</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">成功簽到數</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>checkedInCount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">已簽到總人數</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">💡 說明</h3>
                            <div class="info">
                                <ul style="margin-left: 20px; line-height: 1.8;">
                                    <li>自動為所有未簽到的課程建立簽到記錄（類型為"出席"）</li>
                                    <li>同時為每筆簽到建立對應的 AttendanceFee 記錄</li>
                                    <li>追踪最近一筆 StudentPermissionFee 的 totalAmount 進行費用計算</li>
                                    <li>操作後可立即進行關帳</li>
                                </ul>
                            </div>
                        </div>
                    `;
                    break;

                case 'getCloseAccount':
                    html = `
                        <h2 style="color: #667eea;">💰 取得關帳資料</h2>
                        <div style="margin-top: 20px;">
                            <h3>📖 API 概述</h3>
                            <p><strong>端點：</strong><code>GET /api/v1/CloseAccount/Detail/{date}</code></p>
                            <p><strong>說明：</strong>獲取指定日期的關帳資料，包含簽到檢查和自動計算的關帳金額</p>

                            <h3 style="margin-top: 20px;">📥 請求參數</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead><tr style="background: #667eea; color: white;">
                                    <th style="padding: 8px; border: 1px solid #ddd;">參數</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                </tr></thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>date</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">查詢日期 (格式: yyyy-MM-dd)</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">📤 回應欄位</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead><tr style="background: #667eea; color: white;">
                                    <th style="padding: 8px; border: 1px solid #ddd;">欄位</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                </tr></thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>closeDate</code></td><td style="padding: 8px; border: 1px solid #ddd;">datetime</td><td style="padding: 8px; border: 1px solid #ddd;">關帳日期</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>yesterdayPettyIncome</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">昨日零用金結餘</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>businessIncome</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">營業收入（學生學費）</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>closeAccountAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">關帳結算金額</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>depositAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">提存金額</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>pettyIncome</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">零用金結餘</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">💡 卡控邏輯</h3>
                            <div class="info">
                                <ul style="margin-left: 20px; line-height: 1.8;">
                                    <li><strong>前一日關帳檢查：</strong>若查詢非今日則前一日必須已關帳</li>
                                    <li><strong>簽到狀態檢查：</strong>檢查該日期所有課程是否都已簽到</li>
                                    <li><strong>自動計算：</strong>若無關帳記錄則自動計算；若有則返回已存檔記錄</li>
                                    <li><strong>營業收入計算：</strong>所有該日期 tblPayment 的 Pay + DiscountAmount 之和</li>
                                </ul>
                            </div>
                        </div>
                    `;
                    break;

                case 'saveCloseAccount':
                    html = `
                        <h2 style="color: #667eea;">💾 新增或編輯關帳</h2>
                        <div style="margin-top: 20px;">
                            <h3>📖 API 概述</h3>
                            <p><strong>端點：</strong><code>POST /api/v1/CloseAccount</code></p>
                            <p><strong>說明：</strong>輸入提存金額，系統自動計算零用金結餘並儲存關帳記錄</p>

                            <h3 style="margin-top: 20px;">📥 請求參數</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead><tr style="background: #667eea; color: white;">
                                    <th style="padding: 8px; border: 1px solid #ddd;">參數</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">必填</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                </tr></thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>date</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">✅</td><td style="padding: 8px; border: 1px solid #ddd;">關帳日期 (格式: yyyy-MM-dd)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>depositAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">✅</td><td style="padding: 8px; border: 1px solid #ddd;">提存金額（元）</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">📤 回應欄位</h3>
                            <p>同取得關帳資料的回應欄位</p>

                            <h3 style="margin-top: 20px;">💡 邏輯流程</h3>
                            <div class="info">
                                <ol style="margin-left: 20px; line-height: 1.8;">
                                    <li>檢查前一日是否有關帳記錄（若非今日則必須有）</li>
                                    <li>取得該日期的關帳資料（包含計算的金額）</li>
                                    <li>接收提存金額</li>
                                    <li>計算零用金結餘：PettyIncome = CloseAccountAmount - DepositAmount</li>
                                    <li>若無記錄則新增；若有則更新</li>
                                </ol>
                            </div>

                            <h3 style="margin-top: 20px;">📝 請求範例</h3>
                            <pre style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto;">POST /api/v1/CloseAccount
Content-Type: application/json

{
  "date": "2025-12-16",
  "depositAmount": 5000
}</pre>
                        </div>
                    `;
                    break;

                case 'listCloseAccount':
                    html = `
                        <h2 style="color: #667eea;">📋 取得關帳列表</h2>
                        <div style="margin-top: 20px;">
                            <h3>📖 API 概述</h3>
                            <p><strong>端點：</strong><code>GET /api/v1/CloseAccount?startDate={date}&endDate={date}</code></p>
                            <p><strong>說明：</strong>查詢日期範圍內的所有關帳記錄，按日期降序排列</p>

                            <h3 style="margin-top: 20px;">📥 查詢參數（皆為選填）</h3>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead><tr style="background: #667eea; color: white;">
                                    <th style="padding: 8px; border: 1px solid #ddd;">參數</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                </tr></thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>startDate</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">開始日期 (格式: yyyy-MM-dd，可選)</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>endDate</code></td><td style="padding: 8px; border: 1px solid #ddd;">string</td><td style="padding: 8px; border: 1px solid #ddd;">結束日期 (格式: yyyy-MM-dd，可選)</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">📤 回應欄位</h3>
                            <p>TblCloseAccount[] 的陣列，每筆記錄包含：</p>
                            <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                                <thead><tr style="background: #667eea; color: white;">
                                    <th style="padding: 8px; border: 1px solid #ddd;">欄位</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">類型</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">說明</th>
                                </tr></thead>
                                <tbody>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>closeDate</code></td><td style="padding: 8px; border: 1px solid #ddd;">datetime</td><td style="padding: 8px; border: 1px solid #ddd;">關帳日期</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>yesterdayPettyIncome</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">昨日零用金結餘</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>businessIncome</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">營業收入</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>closeAccountAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">關帳結算金額</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>depositAmount</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">提存金額</td></tr>
                                    <tr><td style="padding: 8px; border: 1px solid #ddd;"><code>pettyIncome</code></td><td style="padding: 8px; border: 1px solid #ddd;">int</td><td style="padding: 8px; border: 1px solid #ddd;">零用金結餘</td></tr>
                                </tbody>
                            </table>

                            <h3 style="margin-top: 20px;">💡 邏輯說明</h3>
                            <div class="info">
                                <ul style="margin-left: 20px; line-height: 1.8;">
                                    <li><strong>預設行為：</strong>若未指定任何日期，則查詢最近 30 天的記錄</li>
                                    <li><strong>單一日期查詢：</strong>只指定開始或結束日期也支援</li>
                                    <li><strong>排序順序：</strong>結果按關帳日期降序排列（最新的在前）</li>
                                </ul>
                            </div>

                            <h3 style="margin-top: 20px;">📝 查詢範例</h3>
                            <pre style="background: #2d3748; color: #e2e8f0; padding: 12px; border-radius: 4px; overflow-x: auto;">GET /api/v1/CloseAccount?startDate=2025-12-01&endDate=2025-12-31

# 或只查詢最近 30 天（不帶參數）
GET /api/v1/CloseAccount</pre>
                        </div>
                    `;
                    break;

            }

            docContent.innerHTML = html;
        }

        // 測試函數
        async function testStudentsList() {
            const resultDiv = document.getElementById('testResult-studentsList');
            resultDiv.innerHTML = '<div class="loading">查詢中...</div>';
            
            try {
                const res = await apiFetch('/api/v1/Students');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                if (data.result !== 1) {
                    throw new Error(data.msg || '查詢失敗');
                }

                const students = data.content || [];
                resultDiv.innerHTML = `
                    <div class="success">✅ 查詢成功，共 ${students.length} 筆資料</div>
                    <div style="padding: 12px; background: #f0f9ff; border-radius: 4px; margin-top: 8px; font-size: 14px; max-height: 200px; overflow-y: auto;">
                        ${students.slice(0, 5).map(s => `<p><strong>ID ${s.studentId}:</strong> ${s.studentName} (${s.userName})</p>`).join('')}
                        ${students.length > 5 ? `<p style="color: #718096;">... 及其他 ${students.length - 5} 筆</p>` : ''}
                    </div>
                `;

                // 顯示 RAW DATA
                document.getElementById('rawData-studentsList').textContent = JSON.stringify(data, null, 2);
            } catch(err) {
                resultDiv.innerHTML = `<div class="error">❌ ${err.message}</div>`;
                document.getElementById('rawData-studentsList').textContent = `錯誤: ${err.message}`;
            }
        }

        async function testAttendanceList() {
            const userId = document.getElementById('testUserId').value;
            if (!userId) {
                alert('請輸入學生 User ID');
                return;
            }

            const resultDiv = document.getElementById('testResult-attendanceList');
            resultDiv.innerHTML = '<div class="loading">查詢中...</div>';
            
            try {
                const res = await apiFetch(`/api/v1/StudentAttendance/${userId}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                if (data.result !== 1) {
                    throw new Error(data.msg || '查詢失敗');
                }

                const records = data.content || [];
                resultDiv.innerHTML = `
                    <div class="success">✅ 查詢成功，共 ${records.length} 筆記錄</div>
                    <div style="padding: 12px; background: #f0f9ff; border-radius: 4px; margin-top: 8px; font-size: 14px; max-height: 200px; overflow-y: auto;">
                        ${records.slice(0, 3).map(r => `
                            <div style="border-bottom: 1px solid #e2e8f0; padding: 8px 0;">
                                <p><strong>課程:</strong> ${r.courseName}</p>
                                <p><strong>應收:</strong> ￥${r.receivableAmount} | <strong>已收:</strong> ￥${r.receivedAmount} | <strong>欠款:</strong> ￥${r.outstandingAmount}</p>
                            </div>
                        `).join('')}
                        ${records.length > 3 ? `<p style="color: #718096; margin-top: 8px;">... 及其他 ${records.length - 3} 筆</p>` : ''}
                    </div>
                `;

                // 顯示 RAW DATA
                document.getElementById('rawData-attendanceList').textContent = JSON.stringify(data, null, 2);
            } catch(err) {
                resultDiv.innerHTML = `<div class="error">❌ ${err.message}</div>`;
                document.getElementById('rawData-attendanceList').textContent = `錯誤: ${err.message}`;
            }
        }

        async function testPaymentDetail() {
            const permissionId = document.getElementById('testPermissionId').value;
            if (!permissionId) {
                alert('請輸入學生權限 ID');
                return;
            }

            const resultDiv = document.getElementById('testResult-paymentDetail');
            resultDiv.innerHTML = '<div class="loading">查詢中...</div>';
            
            try {
                const res = await apiFetch(`/api/v1/StudentAttendance/Detail/${permissionId}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                if (data.result !== 1) {
                    throw new Error(data.msg || '查詢失敗');
                }

                const detail = data.content;
                resultDiv.innerHTML = `
                    <div class="success">✅ 查詢成功</div>
                    <div style="padding: 12px; background: #f0f9ff; border-radius: 4px; margin-top: 8px; font-size: 14px;">
                        <p><strong>課程:</strong> ${detail.courseName || '-'}</p>
                        <p><strong>學生:</strong> ${detail.studentName || '-'}</p>
                        <p><strong>拆帳比:</strong> 課程 ${(detail.courseSplitRatio * 100).toFixed(0)}% | 老師 ${(detail.teacherSplitRatio * 100).toFixed(0)}% | 使用 ${(detail.useSplitRatio * 100).toFixed(0)}%</p>
                        <p><strong>老師分涤:</strong> ￥${detail.teacherRevenue || 0}</p>
                        ${detail.latestPayment ? `<p><strong>最新繳費:</strong> ￥${detail.latestPayment.pay} (折扣: ￥${detail.latestPayment.discountAmount})</p>` : '<p>無繳費記錄</p>'}
                    </div>
                `;

                // 顯示 RAW DATA
                document.getElementById('rawData-paymentDetail').textContent = JSON.stringify(data, null, 2);
            } catch(err) {
                resultDiv.innerHTML = `<div class="error">❌ ${err.message}</div>`;
                document.getElementById('rawData-paymentDetail').textContent = `錯誤: ${err.message}`;
            }
        }

        async function testAttendanceFee() {
            const attendanceId = document.getElementById('testFeeAttendanceId').value;
            const hours = document.getElementById('testFeeHours').value;
            const amount = document.getElementById('testFeeAmount').value;
            const adjust = document.getElementById('testFeeAdjust').value;
            
            if (!attendanceId) {
                alert('請輸入簽到 ID');
                return;
            }

            const body = { attendanceId: parseInt(attendanceId) };
            if (hours) body.hours = parseFloat(hours);
            if (amount) body.amount = parseInt(amount);
            if (adjust) body.adjustmentAmount = parseInt(adjust);

            const resultDiv = document.getElementById('testResult-attendanceFee');
            resultDiv.innerHTML = '<div class="loading">更新中...</div>';
            
            try {
                const res = await apiFetch('/api/v1/StudentAttendance/AttendanceFee', {
                    method: 'PATCH',
                    body: body
                });
                
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                if (data.result !== 1) {
                    throw new Error(data.msg || '更新失敗');
                }

                resultDiv.innerHTML = `
                    <div class="success">✅ 更新成功</div>
                    <div style="padding: 12px; background: #f0fff4; border-radius: 4px; margin-top: 8px; font-size: 14px;">
                        <p><strong>簽到 ID:</strong> ${attendanceId}</p>
                        ${hours ? `<p><strong>扣課時數:</strong> ${hours}</p>` : ''}
                        ${amount ? `<p><strong>單堂學費:</strong> ￥${amount}</p>` : ''}
                        ${adjust ? `<p><strong>單堂增減:</strong> ￥${adjust}</p>` : ''}
                    </div>
                `;

                // 顯示 RAW DATA
                document.getElementById('rawData-attendanceFee').textContent = JSON.stringify(data, null, 2);
            } catch(err) {
                resultDiv.innerHTML = `<div class="error">❌ ${err.message}</div>`;
                document.getElementById('rawData-attendanceFee').textContent = `錯誤: ${err.message}`;
            }
        }

        async function testUpdateStudentPermissionFee() {
            const feeId = document.getElementById('testUpdateFeeId').value;
            const paymentDate = document.getElementById('testUpdatePaymentDate').value;
            const totalAmount = document.getElementById('testUpdateTotalAmount').value;
            const isDelete = document.getElementById('testUpdateIsDelete').value === 'true';
            
            if (!feeId) {
                alert('請輸入費用 ID');
                return;
            }

            const body = { 
                studentPermissionFeeId: parseInt(feeId),
                IsDelete: isDelete
            };
            if (paymentDate) body.paymentDate = paymentDate;
            if (totalAmount) body.totalAmount = parseInt(totalAmount);

            const resultDiv = document.getElementById('testResult-updatePermissionFee');
            resultDiv.innerHTML = '<div class="loading">處理中...</div>';
            
            try {
                const res = await apiFetch('/api/v2/StudentAttendance', {
                    method: 'PATCH',
                    body: body
                });
                
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                if (data.result !== 0) {
                    throw new Error(data.msg || '操作失敗');
                }

                resultDiv.innerHTML = `
                    <div class="success">✅ 操作成功</div>
                    <div style="padding: 12px; background: #f0fff4; border-radius: 4px; margin-top: 8px; font-size: 14px;">
                        <p><strong>費用 ID:</strong> ${feeId}</p>
                        ${paymentDate ? `<p><strong>繳款日期:</strong> ${paymentDate}</p>` : ''}
                        ${totalAmount ? `<p><strong>總金額:</strong> ￥${totalAmount}</p>` : ''}
                        <p><strong>操作:</strong> ${isDelete ? '刪除記錄' : '更新記錄'}</p>
                    </div>
                `;

                // 顯示 RAW DATA
                document.getElementById('rawData-updatePermissionFee').textContent = JSON.stringify(data, null, 2);
            } catch(err) {
                resultDiv.innerHTML = `<div class="error">❌ ${err.message}</div>`;
                document.getElementById('rawData-updatePermissionFee').textContent = `錯誤: ${err.message}`;
            }
        }

        // ========== 繳費管理功能 ==========
        
        async function getStudentPaymentInfo() {
            const permissionFeeId = document.getElementById('paymentStudentPermissionFeeId').value;
            if (!permissionFeeId) {
                alert('請輸入學生權限費用 ID');
                return;
            }

            const resultDiv = document.getElementById('paymentContent');
            const errorDiv = document.getElementById('paymentError');
            resultDiv.innerHTML = '<div class="loading">載入中...</div>';
            errorDiv.style.display = 'none';

            try {
                const res = await apiFetch(`/api/v1/StudentPayment/${permissionFeeId}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                
                if (data.result !== 1) {
                    throw new Error(data.msg || '查詢失敗');
                }

                const payment = data.content;
                let html = `
                    <div style="padding: 16px; background: #f0f9ff; border-radius: 8px; border: 1px solid #b3d8ff; margin-bottom: 16px;">
                        <h4>基本資訊</h4>
                        <table style="width: 100%; font-size: 14px;">
                            <tr><th>課程名稱</th><td>${payment.courseName || '無'}</td></tr>
                            <tr><th>學生姓名</th><td>${payment.studentName || '無'}</td></tr>
                            <tr><th>當筆金額</th><td style="color: #409eff; font-weight: bold;">¥${payment.currentAmount || 0}</td></tr>
                            <tr><th>總額折扣</th><td style="color: #f56c6c; font-weight: bold;">-¥${payment.totalDiscount || 0}</td></tr>
                            <tr><th>應收金額</th><td style="color: #409eff; font-weight: bold;">¥${payment.receivableAmount || 0}</td></tr>
                            <tr><th>已收金額</th><td style="color: #67c23a; font-weight: bold;">¥${payment.paidAmount || 0}</td></tr>
                            <tr><th>欠款金額</th><td style="color: #e6a23c; font-weight: bold;">¥${payment.outstandingAmount || 0}</td></tr>
                            <tr><th>最新繳費日期</th><td>${payment.payDate || '無'}</td></tr>
                            <tr><th>最新收據編號</th><td>${payment.receiptNumber || '無'}</td></tr>
                            <tr><th>最新備註</th><td>${payment.remark || '無'}</td></tr>
                        </table>
                    </div>
                `;

                resultDiv.innerHTML = html;
            } catch(err) {
                errorDiv.textContent = err.message;
                errorDiv.style.display = 'block';
                resultDiv.innerHTML = '';
            }
        }

        function clearPaymentInfo() {
            document.getElementById('paymentContent').innerHTML = '';
            document.getElementById('paymentError').style.display = 'none';
            document.getElementById('paymentStudentPermissionFeeId').value = '1';
        }

        async function createPaymentRecord() {
            const feeId = document.getElementById('createPaymentFeeId').value;
            const pay = parseInt(document.getElementById('createPaymentAmount').value);
            const discount = parseFloat(document.getElementById('createPaymentDiscount').value) || 0;
            const remark = document.getElementById('createPaymentRemark').value || null;

            if (!feeId || !pay) {
                alert('請填寫必填欄位：學生權限費用ID、金額');
                return;
            }

            const resultDiv = document.getElementById('createPaymentResult');
            const errorDiv = document.getElementById('createPaymentError');
            resultDiv.innerHTML = '<div class="loading">儲存中...</div>';
            errorDiv.style.display = 'none';

            try {
                const payload = {
                    studentPermissionFeeId: parseInt(feeId),
                    pay: pay,
                    discountAmount: discount,
                    remark: remark
                };

                const res = await apiFetch('/api/v1/StudentPayment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                
                if (data.result !== 1) {
                    throw new Error(data.msg || '儲存失敗');
                }

                const isCreated = data.msg === 'created';
                const isUpdated = data.msg === 'updated';
                const actionText = isCreated ? '新增' : isUpdated ? '更新' : '儲存';

                resultDiv.innerHTML = `
                    <div class="success">✅ ${actionText}成功</div>
                    <div style="padding: 12px; background: #f0f9ff; border-radius: 4px; margin-top: 8px; font-size: 14px;">
                        <p><strong>操作：</strong>${actionText}</p>
                        <p><strong>學生權限費用ID：</strong>${feeId}</p>
                        <p><strong>繳費金額：</strong>$${pay}</p>
                        <p><strong>折扣金額：</strong>$${discount}</p>
                        ${remark ? `<p><strong>備註：</strong>${remark}</p>` : ''}
                    </div>
                `;
                
                // 清空表單
                document.getElementById('createPaymentAmount').value = '';
                document.getElementById('createPaymentDiscount').value = '0';
                document.getElementById('createPaymentRemark').value = '';
            } catch(err) {
                errorDiv.textContent = err.message;
                errorDiv.style.display = 'block';
                resultDiv.innerHTML = '';
            }
        }

        async function loadPaymentForEdit() {
            const paymentId = document.getElementById('editPaymentId').value;
            if (!paymentId) {
                alert('請輸入繳費 ID');
                return;
            }
            // 可以從查詢結果中載入，這裡簡化為直接顯示 ID
            alert('請輸入要編輯的繳費ID，然後修改欄位');
        }

        async function updatePaymentRecord() {
            const paymentId = document.getElementById('editPaymentId').value;
            if (!paymentId) {
                alert('請輸入繳費 ID');
                return;
            }

            const payload = {};
            const payDate = document.getElementById('editPaymentDate').value;
            if (payDate) payload.payDate = payDate;
            
            const pay = document.getElementById('editPaymentAmount').value;
            if (pay) payload.pay = parseInt(pay);
            
            const discount = document.getElementById('editPaymentDiscount').value;
            if (discount !== '') payload.discountAmount = parseFloat(discount);
            
            const remark = document.getElementById('editPaymentRemark').value;
            if (remark) payload.remark = remark;

            if (Object.keys(payload).length === 0) {
                alert('請至少修改一個欄位');
                return;
            }

            const resultDiv = document.getElementById('editPaymentResult');
            const errorDiv = document.getElementById('editPaymentError');
            resultDiv.innerHTML = '<div class="loading">更新中...</div>';
            errorDiv.style.display = 'none';

            try {
                const res = await apiFetch(`/api/v1/StudentPayment/${paymentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                
                if (data.result !== 1) {
                    throw new Error(data.msg || '更新失敗');
                }

                resultDiv.innerHTML = '<div class="success">✅ 更新成功</div>';
                
                // 清空表單
                document.getElementById('editPaymentId').value = '';
                document.getElementById('editPaymentDate').value = '';
                document.getElementById('editPaymentAmount').value = '';
                document.getElementById('editPaymentDiscount').value = '';
                document.getElementById('editPaymentRemark').value = '';
            } catch(err) {
                errorDiv.textContent = err.message;
                errorDiv.style.display = 'block';
                resultDiv.innerHTML = '';
            }
        }

        async function deletePaymentRecord() {
            const paymentId = document.getElementById('editPaymentId').value;
            if (!paymentId) {
                alert('請輸入繳費 ID');
                return;
            }

            if (!confirm('確定要刪除此繳費記錄嗎？')) {
                return;
            }

            const resultDiv = document.getElementById('editPaymentResult');
            const errorDiv = document.getElementById('editPaymentError');
            resultDiv.innerHTML = '<div class="loading">刪除中...</div>';
            errorDiv.style.display = 'none';

            try {
                const res = await apiFetch(`/api/v1/StudentPayment/${paymentId}`, {
                    method: 'DELETE'
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                
                if (data.result !== 1) {
                    throw new Error(data.msg || '刪除失敗');
                }

                resultDiv.innerHTML = '<div class="success">✅ 刪除成功</div>';
                
                // 清空表單
                document.getElementById('editPaymentId').value = '';
            } catch(err) {
                errorDiv.textContent = err.message;
                errorDiv.style.display = 'block';
                resultDiv.innerHTML = '';
            }
        }

        // 測試取得學生繳費資訊
        async function testGetPaymentInfo() {
            const permissionId = document.getElementById('testGetPaymentPermissionId').value;
            if (!permissionId) {
                alert('請輸入學生權限 ID');
                return;
            }

            const resultDiv = document.getElementById('testResult-getPaymentInfo');
            resultDiv.innerHTML = '<div class="loading">查詢中...</div>';

            try {
                const res = await apiFetch(`/api/v1/StudentPayment/${permissionId}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                if (data.result !== 1) {
                    throw new Error(data.msg || '查詢失敗');
                }

                const payment = data.content;
                resultDiv.innerHTML = `
                    <div class="success">✅ 查詢成功</div>
                    <div style="padding: 12px; background: #f0f9ff; border-radius: 4px; margin-top: 8px; font-size: 14px;">
                        <p><strong>課程:</strong> ${payment.courseName || '-'}</p>
                        <p><strong>學生:</strong> ${payment.studentName || '-'}</p>
                        <p><strong>當筆金額:</strong> ￥${payment.currentAmount}</p>
                        <p><strong>應收金額:</strong> ￥${payment.receivableAmount}</p>
                        <p><strong>已收金額:</strong> ￥${payment.paidAmount}</p>
                        <p><strong>欠款金額:</strong> ￥${payment.outstandingAmount}</p>
                        <p><strong>繳費日期:</strong> ${payment.payDate || '-'}</p>
                        <p><strong>收據編號:</strong> ${payment.receiptNumber || '-'}</p>
                        <p><strong>備註:</strong> ${payment.remark || '-'}</p>
                    </div>
                `;

                // 顯示 RAW DATA
                document.getElementById('rawData-getPaymentInfo').textContent = JSON.stringify(data, null, 2);
            } catch(err) {
                resultDiv.innerHTML = `<div class="error">❌ ${err.message}</div>`;
                document.getElementById('rawData-getPaymentInfo').textContent = `錯誤: ${err.message}`;
            }
        }

        // 測試建立繳費記錄
        async function testCreatePayment() {
            const permissionId = document.getElementById('testCreatePermissionId').value;
            const pay = document.getElementById('testCreatePay').value;
            
            if (!permissionId || !pay) {
                alert('請輸入學生權限 ID 和繳費金額');
                return;
            }

            const payload = {
                studentPermissionId: parseInt(permissionId),
                pay: parseInt(pay)
            };

            const discount = document.getElementById('testCreateDiscount').value;
            if (discount) payload.discountAmount = parseFloat(discount);

            const remark = document.getElementById('testCreateRemark').value;
            if (remark) payload.remark = remark;

            const resultDiv = document.getElementById('testResult-createPayment');
            resultDiv.innerHTML = '<div class="loading">建立中...</div>';

            try {
                const res = await apiFetch('/api/v1/StudentPayment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                if (data.result !== 1) {
                    throw new Error(data.msg || '建立失敗');
                }

                resultDiv.innerHTML = `
                    <div class="success">✅ 建立成功</div>
                    <div style="padding: 12px; background: #f0fff4; border-radius: 4px; margin-top: 8px; font-size: 14px;">
                        <p><strong>繳費 ID:</strong> ${data.content?.paymentId || '-'}</p>
                        <p><strong>繳費日期:</strong> ${data.content?.payDate || '自動產生'}</p>
                        <p><strong>收據編號:</strong> ${data.content?.receiptNumber || '自動產生'}</p>
                        <p><strong>繳費金額:</strong> ￥${pay}</p>
                        <p><strong>折扣金額:</strong> ￥${discount || 0}</p>
                    </div>
                `;

                // 清空表單
                // 顯示 RAW DATA
                document.getElementById('rawData-createPayment').textContent = JSON.stringify(data, null, 2);

                document.getElementById('testCreatePermissionId').value = '';
                document.getElementById('testCreatePay').value = '';
                document.getElementById('testCreateDiscount').value = '0';
                document.getElementById('testCreateRemark').value = '';
            } catch(err) {
                resultDiv.innerHTML = `<div class="error">❌ ${err.message}</div>`;
                document.getElementById('rawData-createPayment').textContent = `錯誤: ${err.message}`;
            }
        }

        // 測試更新繳費記錄
        async function testUpdatePayment() {
            const paymentId = document.getElementById('testUpdatePaymentId').value;
            if (!paymentId) {
                alert('請輸入繳費 ID');
                return;
            }

            const payload = {};
            const payDate = document.getElementById('testUpdatePayDate').value;
            if (payDate) payload.payDate = payDate;
            
            const pay = document.getElementById('testUpdatePay').value;
            if (pay) payload.pay = parseInt(pay);
            
            const discount = document.getElementById('testUpdateDiscount').value;
            if (discount !== '') payload.discountAmount = parseFloat(discount);
            
            const remark = document.getElementById('testUpdateRemark').value;
            if (remark) payload.remark = remark;

            if (Object.keys(payload).length === 0) {
                alert('請至少修改一個欄位');
                return;
            }

            const resultDiv = document.getElementById('testResult-updatePayment');
            resultDiv.innerHTML = '<div class="loading">更新中...</div>';

            try {
                const res = await apiFetch(`/api/v1/StudentPayment/${paymentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                if (data.result !== 1) {
                    throw new Error(data.msg || '更新失敗');
                }

                resultDiv.innerHTML = `
                    <div class="success">✅ 更新成功</div>
                    <div style="padding: 12px; background: #fffbeb; border-radius: 4px; margin-top: 8px; font-size: 14px;">
                        <p><strong>已更新的欄位:</strong></p>
                        ${payDate ? `<p>繳費日期: ${payDate}</p>` : ''}
                        ${pay ? `<p>繳費金額: ￥${pay}</p>` : ''}
                        ${discount !== '' ? `<p>折扣金額: ￥${discount}</p>` : ''}
                        ${remark ? `<p>備註: ${remark}</p>` : ''}
                    </div>
                `;

                // 清空表單
                // 顯示 RAW DATA
                document.getElementById('rawData-updatePayment').textContent = JSON.stringify(data, null, 2);

                document.getElementById('testUpdatePaymentId').value = '';
                document.getElementById('testUpdatePayDate').value = '';
                document.getElementById('testUpdatePay').value = '';
                document.getElementById('testUpdateDiscount').value = '';
                document.getElementById('testUpdateRemark').value = '';
            } catch(err) {
                resultDiv.innerHTML = `<div class="error">❌ ${err.message}</div>`;
                document.getElementById('rawData-updatePayment').textContent = `錯誤: ${err.message}`;
            }
        }

        // 課程相關測試函數
        async function testCoursesList() {
            const resultDiv = document.getElementById('testResult-coursesList');
            resultDiv.innerHTML = '<div class="loading">載入中...</div>';

            try {
                const res = await apiFetch('/api/v2/Courses');
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const courses = data.content || data || [];

                if (courses.length === 0) {
                    resultDiv.innerHTML = '<div class="info">📭 未找到課程</div>';
                } else {
                    resultDiv.innerHTML = `
                        <div class="success">✅ 查詢成功，共 ${courses.length} 筆課程</div>
                        <div style="padding: 12px; background: #f0f9ff; border-radius: 4px; margin-top: 8px; font-size: 14px; max-height: 200px; overflow-y: auto;">
                            ${courses.slice(0, 3).map(c => `
                                <div style="border-bottom: 1px solid #e2e8f0; padding: 8px 0;">
                                    <p><strong>${c.courseName || c.name}</strong> (ID: ${c.courseId || c.id})</p>
                                    <p style="color: #666; font-size: 12px;">類型: ${c.courseTypeName || '-'} | 費用: ￥${c.amount || '-'}</p>
                                </div>
                            `).join('')}
                            ${courses.length > 3 ? `<p style="color: #718096; margin-top: 8px;">... 及其他 ${courses.length - 3} 門課程</p>` : ''}
                        </div>
                    `;
                }

                document.getElementById('rawData-coursesList').textContent = JSON.stringify(data, null, 2);
            } catch(err) {
                resultDiv.innerHTML = `<div class="error">❌ ${err.message}</div>`;
                document.getElementById('rawData-coursesList').textContent = `錯誤: ${err.message}`;
            }
        }

        async function testCourseDetail() {
            const courseId = document.getElementById('testCourseDetailId').value;
            if (!courseId) {
                alert('請輸入課程 ID');
                return;
            }

            const resultDiv = document.getElementById('testResult-courseDetail');
            resultDiv.innerHTML = '<div class="loading">載入中...</div>';

            try {
                const res = await apiFetch(`/api/v2/Course/${courseId}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const course = data.content || data;

                if (!course || !course.courseId) {
                    resultDiv.innerHTML = '<div class="info">📭 課程不存在</div>';
                } else {
                    resultDiv.innerHTML = `
                        <div class="success">✅ 查詢成功</div>
                        <div style="padding: 12px; background: #f0f9ff; border-radius: 4px; margin-top: 8px; font-size: 14px;">
                            <p><strong>課程名稱:</strong> ${course.courseName || '-'}</p>
                            <p><strong>課程類型:</strong> ${course.courseTypeName || '-'}</p>
                            <p><strong>費用:</strong> ￥${course.amount || '-'} | <strong>教材費:</strong> ￥${course.materialFee || '-'}</p>
                            <p><strong>時數:</strong> ${course.hours || '-'} | <strong>拆帳比例:</strong> ${course.splitRatio ? (course.splitRatio * 100).toFixed(0) + '%' : '-'}</p>
                        </div>
                    `;
                }

                document.getElementById('rawData-courseDetail').textContent = JSON.stringify(data, null, 2);
            } catch(err) {
                resultDiv.innerHTML = `<div class="error">❌ ${err.message}</div>`;
                document.getElementById('rawData-courseDetail').textContent = `錯誤: ${err.message}`;
            }
        }

        async function testSalaryReport() {
            const startDate = document.getElementById('testSalaryStartDate').value;
            const endDate = document.getElementById('testSalaryEndDate').value;
            const teacherId = parseInt(document.getElementById('testSalaryTeacherId').value || '0', 10);
            const includePaid = document.getElementById('testSalaryIncludePaid').value;

            const resultDiv = document.getElementById('testResult-salaryReport');
            const rawDiv = document.getElementById('rawData-salaryReport');
            resultDiv.innerHTML = '<div class="loading">生成中...</div>';
            rawDiv.textContent = '';

            if (!startDate || !endDate || !teacherId) {
                resultDiv.innerHTML = '<div class="error">❌ 請輸入結算日期與老師 ID</div>';
                return;
            }

            try {
                const res = await apiFetch(`/api/pdf/v1/SalaryReport?startDate=${startDate}&endDate=${endDate}&teacherId=${teacherId}&includePaid=${includePaid}`, {
                    headers: { 'Accept': 'application/pdf' }
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const blob = await res.blob();
                const url = URL.createObjectURL(blob);

                resultDiv.innerHTML = `<div class="success">✅ PDF 產生成功 <a href="${url}" download="salary-report-${startDate}-${endDate}.pdf" target="_blank" style="color:#409eff;">下載/預覽</a></div>`;
                rawDiv.textContent = `type: ${blob.type || 'unknown'}; size: ${blob.size} bytes`;

                setTimeout(() => URL.revokeObjectURL(url), 60000);
            } catch(err) {
                resultDiv.innerHTML = `<div class="error">❌ ${err.message}</div>`;
                rawDiv.textContent = `錯誤: ${err.message}`;
            }
        }

        async function testCompanyProfit() {
            const startDate = document.getElementById('testProfitStartDate').value;
            const endDate = document.getElementById('testProfitEndDate').value;
            const teacherId = document.getElementById('testProfitTeacherId').value;
            const includePaid = document.getElementById('testProfitIncludePaid').value;

            const resultDiv = document.getElementById('testResult-companyProfit');
            const rawDiv = document.getElementById('rawData-companyProfit');
            resultDiv.innerHTML = '<div class="loading">生成中...</div>';
            rawDiv.textContent = '';

            if (!startDate || !endDate || !teacherId) {
                resultDiv.innerHTML = '<div class="error">❌ 請輸入結算日期和老師 ID</div>';
                return;
            }

            try {
                const url = `/api/pdf/v1/CompanyProfitSummary?startDate=${startDate}&endDate=${endDate}&teacherId=${teacherId}&includePaid=${includePaid}`;

                const res = await apiFetch(url, {
                    headers: { 'Accept': 'application/pdf' }
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const blob = await res.blob();
                const blobUrl = URL.createObjectURL(blob);

                resultDiv.innerHTML = `<div class="success">✅ PDF 產生成功 <a href="${blobUrl}" download="company-profit-summary-${startDate}-${endDate}-teacher-${teacherId}.pdf" target="_blank" style="color:#409eff;">下載/預覽</a></div>`;
                rawDiv.textContent = `type: ${blob.type || 'unknown'}; size: ${blob.size} bytes`;

                setTimeout(() => URL.revokeObjectURL(blobUrl), 60000);
            } catch(err) {
                resultDiv.innerHTML = `<div class="error">❌ ${err.message}</div>`;
                rawDiv.textContent = `錯誤: ${err.message}`;
            }
        }
    </script>
</body>
</html>